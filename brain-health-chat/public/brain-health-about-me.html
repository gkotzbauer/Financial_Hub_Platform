<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Health Chat - About Me Edition</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 4px 0;
            font-size: 20px;
            font-weight: 600;
        }

        .header p {
            margin: 4px 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .user-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .user-controls button {
            font-size: 16px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .user-dropdown-container {
            position: relative;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 150px;
            z-index: 100;
            margin-top: 4px;
        }

        .user-dropdown button {
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
        }

        .user-dropdown button:hover {
            background: #f5f5f5;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-width: 1200px;
            width: 90%;
            margin: 0 auto;
        }

        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message, .user-message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
            font-size: 18px;
        }

        .bot-message {
            background: white;
            border: 1px solid #e0e0e0;
            align-self: flex-start;
        }

        .user-message {
            background: #667eea;
            color: white;
            margin-left: auto;
            align-self: flex-end;
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            width: fit-content;
            margin-bottom: 16px;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .input-wrapper {
            max-width: 1200px;
            width: 90%;
            margin: 0 auto;
        }

        .answer-options {
            margin-bottom: 12px;
        }

        .answer-options p {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #666;
        }

        .answer-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .answer-button {
            padding: 8px 16px;
            border: 1px solid #667eea;
            background: #f8f9ff;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .answer-button:hover {
            background: #667eea;
            color: white;
        }

        .answer-button.other {
            background: #f5f5f5;
            border-color: #ccc;
            color: #666;
            font-size: 13px;
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 17px;
            outline: none;
        }

        input[type="text"]:focus {
            border-color: #667eea;
        }

        .send-button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .send-button:hover {
            background: #5a67d8;
        }

        .session-menu {
            display: grid;
            gap: 12px;
            margin-top: 16px;
        }

        .session-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .session-info {
            flex: 1;
        }

        .session-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .session-hint {
            font-size: 12px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }

        .completed-icon {
            color: #48bb78;
            font-size: 20px;
        }

        .progress-dashboard {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .progress-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .progress-card {
            background: #f8f9ff;
            border-radius: 8px;
            padding: 16px;
        }

        .progress-card h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #667eea;
        }

        .about-me-section {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .about-me-section h3 {
            color: #2e7d32;
            margin: 0 0 12px 0;
        }

        .about-me-item {
            background: white;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .about-me-item.best-life {
            border-left: 3px solid #4caf50;
        }

        .about-me-item.concern {
            border-left: 3px solid #ff9800;
        }

        .assessment-trend {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        .trend-emoji {
            font-size: 20px;
        }

        .session-completion {
            background: #f5f5f5;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            font-size: 14px;
        }

        .completion-header {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .completion-details {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        .chart-container {
            margin: 20px 0;
            height: 200px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .chat-container {
                padding: 12px;
            }

            .bot-message, .user-message {
                max-width: 85%;
            }

            .progress-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>üß† Sofia - Your Brain Health Companion</h1>
                <p>The partner you need to optimize your brain health and quality of life while aging</p>
            </div>
            <div class="user-controls">
                <button onclick="setShowProgress(true)" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    üìä Progress
                </button>
                <button onclick="exportProgress()" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    üì• Export
                </button>
                <div class="user-dropdown-container">
                    <button onclick="setShowUserDropdown(!showUserDropdown)" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        üë§ <span id="currentUserName">User 1</span> ‚ñº
                    </button>
                    <div class="user-dropdown" id="userDropdown" style="display: none;">
                        <button onclick="createNewUser()">‚ûï New User</button>
                        <div id="userList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="typing-indicator" id="typingIndicator">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <div class="input-container">
        <div class="input-wrapper">
            <div class="answer-options" id="answerOptions" style="display: none;">
                <p>Choose an option or type your own response:</p>
                <div class="answer-buttons" id="answerButtons"></div>
            </div>
            <div class="input-group">
                <input type="text" id="userInput" placeholder="Type your response..." />
                <button class="send-button" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <div class="progress-dashboard" id="progressDashboard" style="display: none;">
        <div class="progress-content">
            <div class="progress-header">
                <h2>Your Progress Dashboard</h2>
                <button class="close-button" onclick="setShowProgress(false)">√ó</button>
            </div>

            <!-- About Me Summary -->
            <div class="about-me-section" id="aboutMeSummary" style="display: none;">
                <h3>üíö About Me Profile</h3>
                <div id="aboutMeContent"></div>
            </div>

            <!-- Lessons Completed -->
            <div class="progress-card">
                <h3>üìö Lessons Completed</h3>
                <div id="lessonsCompletedContent"></div>
            </div>

            <!-- Assessment Progress -->
            <div class="progress-card">
                <h3>üìä Knowledge Progress</h3>
                <div id="assessmentProgressContent"></div>
            </div>

            <div class="progress-grid" id="progressGrid">
                <!-- Dynamic progress content will be inserted here -->
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button onclick="exportProgress()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    üì• Export Full Report
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize React (placeholder for actual React integration)
        const React = { useState: () => [null, () => {}], useEffect: () => {}, useRef: () => ({current: null}) };
        const ChevronRight = () => null;
        const Brain = () => null;
        const User = () => null;
        const Bot = () => null;
        const Calendar = () => null;
        const CheckCircle = () => null;
        const Lock = () => null;
        const Unlock = () => null;
        const Download = () => null;
        const BarChart3 = () => null;
        const Play = () => null;
        const X = () => null;
        const AlertCircle = () => null;

        // Default user history structure with About Me enhancements
        function createDefaultUserHistory() {
            return {
                userId: "",
                name: "",
                age: "",
                diagnosis: "",
                referral_info: {},
                assessment_info: {},
                current_symptoms: {},
                assessment_results: {},
                patient_background: {},
                completedSessions: [],
                sessionScores: {},
                exerciseResults: [],
                responses: [],
                conversationHistory: [],
                lastUpdated: null,

                // Enhanced About Me Profile
                aboutMe: {
                    bestLifeElements: [],
                    concerns: [],
                    confidenceLevel: "",
                    confidenceTimestamp: null,
                    profileCompleteness: 0,
                    lastUpdated: null,

                    // NEW: Lessons Completed section
                    lessonsCompleted: {
                        sessions: [],
                        totalCompleted: 0,
                        lastCompletedDate: null,
                        completionRate: 0
                    },

                    // NEW: Assessment Responses section
                    assessmentResponses: {
                        bySession: {},
                        knowledgeProgression: {
                            familiarity: [],
                            confidence: [],
                            readiness: []
                        },
                        improvementMetrics: {
                            familiarityTrend: null,
                            confidenceTrend: null,
                            averageImprovement: 0
                        }
                    }
                }
            };
        }

        // Comprehensive diagnostic profile with About Me
        const diagnosticProfile = {
            userId: "user1",
            name: "User 1",
            diagnosis: "Mild Cognitive Impairment (F06.7)",
            referral_info: {
                clinic_name: "Brain Health Clinic",
                referral_reason: "further investigation and follow-up related to concerns around your cognition (thinking and memory)",
                referring_provider: "Southwark and Lambeth Memory Service (SLMS)"
            },
            assessment_info: {
                date: "19/Nov/2024",
                clinicians: [
                    { name: "Professor Dag Aarsland", role: "Consultant Psychiatrist" },
                    { name: "Viyash Muniswaran", role: "Research Assistant" }
                ]
            },
            current_symptoms: {
                sleep_patterns: ["experience nightmares", "snoring", "occasional talking during sleep"],
                physical_challenges: [],
                cognitive_challenges: ["Mild Cognitive Impairment", "Alzheimer's"],
                instrumental_activities_daily_living: {
                    transportation: ["trouble finding your way while driving"],
                    managing_finances: ["difficulties with managing finances"]
                }
            },
            assessment_results: {
                HADS: { anxiety: "12/21", depression: "9/21" },
                ACE_III: {
                    total: "98/100",
                    domain_performance: {
                        Memory: "25/26",
                        Fluency: "13/14",
                        Language: "26/26",
                        Visuospatial: "16/16",
                        "Attention and Orientation": "18/18"
                    }
                }
            },
            patient_background: {
                family_history: {
                    father: "diagnosed with Alzheimer's in his early 80s",
                    mother: "diagnosed with vascular dementia and frontotemporal dementia in her 90s"
                },
                symptom_duration: "more than 10 years",
                employment_status: "retired",
                caregiving_history: "been a carer for your poorly mother",
                previous_occupation: "led the council's work on research and policy"
            },
            completedSessions: [],
            sessionScores: {},
            exerciseResults: [],
            responses: [],
            conversationHistory: [],
            lastUpdated: null,

            // About Me Profile
            aboutMe: {
                bestLifeElements: [],
                concerns: [],
                confidenceLevel: "",
                confidenceTimestamp: null,
                profileCompleteness: 0,
                lastUpdated: null,
                lessonsCompleted: {
                    sessions: [],
                    totalCompleted: 0,
                    lastCompletedDate: null,
                    completionRate: 0
                },
                assessmentResponses: {
                    bySession: {},
                    knowledgeProgression: {
                        familiarity: [],
                        confidence: [],
                        readiness: []
                    },
                    improvementMetrics: {
                        familiarityTrend: null,
                        confidenceTrend: null,
                        averageImprovement: 0
                    }
                }
            }
        };

        // Session-specific baseline questions
        const getSessionSpecificQuestions = (sessionId) => {
            const sessionQuestions = {
                1: [
                    {
                        question: "How familiar are you with brain health fundamentals, such as what is happening to the brain as we age?",
                        scale: "1 (Not at all familiar) to 5 (Very familiar)"
                    },
                    {
                        question: "How confident are you in your ability to optimize your brain health based on the fundamentals of living with a healthy brain as you age?",
                        scale: "1 (Not confident) to 5 (Very confident)"
                    },
                    {
                        question: "Next, I will guide you through a few lessons to help you better understand what is happening to your brain as you age. Are you ready to begin?",
                        scale: ""
                    }
                ],
                2: [
                    {
                        question: "How familiar are you with Mild Cognitive Impairment (MCI) and early warning signs of cognitive changes?",
                        scale: "1 (Not at all familiar) to 5 (Very familiar)"
                    },
                    {
                        question: "How confident are you in your ability to recognize and respond to early warning signs of cognitive changes?",
                        scale: "1 (Not confident) to 5 (Very confident)"
                    },
                    {
                        question: "Next, I will guide you through understanding MCI and its early warning signs. Are you ready to begin?",
                        scale: ""
                    }
                ],
                3: [
                    {
                        question: "How familiar are you with cognitive strategies and current treatment options for brain health?",
                        scale: "1 (Not at all familiar) to 5 (Very familiar)"
                    },
                    {
                        question: "How confident are you in your ability to implement cognitive strategies and make informed decisions about treatments?",
                        scale: "1 (Not confident) to 5 (Very confident)"
                    },
                    {
                        question: "Next, I will guide you through practical cognitive strategies and current treatment options. Are you ready to begin?",
                        scale: ""
                    }
                ],
                4: [
                    {
                        question: "How familiar are you with the connection between mood, mental health, and brain health?",
                        scale: "1 (Not at all familiar) to 5 (Very familiar)"
                    },
                    {
                        question: "How confident are you in your ability to manage your mood to protect your cognitive health?",
                        scale: "1 (Not confident) to 5 (Very confident)"
                    },
                    {
                        question: "Next, I will guide you through understanding how mood and mental health affect your brain. Are you ready to begin?",
                        scale: ""
                    }
                ],
                5: [
                    {
                        question: "How familiar are you with relaxation techniques, stress management, and sleep's role in brain health?",
                        scale: "1 (Not at all familiar) to 5 (Very familiar)"
                    },
                    {
                        question: "How confident are you in your ability to manage stress and improve sleep for better brain health?",
                        scale: "1 (Not confident) to 5 (Very confident)"
                    },
                    {
                        question: "Next, I will guide you through relaxation techniques and sleep strategies for brain health. Are you ready to begin?",
                        scale: ""
                    }
                ],
                6: [
                    {
                        question: "How familiar are you with lifestyle factors like exercise, diet, and social engagement for brain health?",
                        scale: "1 (Not at all familiar) to 5 (Very familiar)"
                    },
                    {
                        question: "How confident are you in your ability to make lifestyle changes that support your brain health?",
                        scale: "1 (Not confident) to 5 (Very confident)"
                    },
                    {
                        question: "Next, I will guide you through creating a brain-healthy lifestyle plan. Are you ready to begin?",
                        scale: ""
                    }
                ],
                7: [
                    {
                        question: "How familiar are you with cognitive training methods and creating a comprehensive brain health plan?",
                        scale: "1 (Not at all familiar) to 5 (Very familiar)"
                    },
                    {
                        question: "How confident are you in your ability to maintain a long-term brain health program?",
                        scale: "1 (Not confident) to 5 (Very confident)"
                    },
                    {
                        question: "Next, I will guide you through cognitive training and help you create your personalized brain health action plan. Are you ready to begin?",
                        scale: ""
                    }
                ]
            };

            return sessionQuestions[sessionId] || sessionQuestions[1];
        };

        // Personalized baseline questions based on diagnosis
        const getPersonalizedBaselineQuestions = (sessionId, profile) => {
            return getSessionSpecificQuestions(sessionId);
        };

        // Get personalized session content
        const getPersonalizedContent = (sessionId, profile) => {
            const hasMCI = profile.diagnosis?.includes("Mild Cognitive Impairment");
            const challengeAreas = [];

            if (profile.current_symptoms?.instrumental_activities_daily_living?.managing_finances?.length > 0) {
                challengeAreas.push("financial management");
            }
            if (profile.current_symptoms?.instrumental_activities_daily_living?.transportation?.length > 0) {
                challengeAreas.push("navigation");
            }

            // Placeholder content structure
            return {
                title: `Session ${sessionId} Content`,
                modules: [
                    {
                        type: "content",
                        title: "Session Overview",
                        segments: [
                            {
                                content: `Welcome to Session ${sessionId}. This session will help you understand important aspects of brain health.`,
                                discussion: "How are you feeling about starting this session?",
                                discussionOptions: ['Ready to learn', 'A bit nervous', 'Excited to continue']
                            }
                        ]
                    }
                ]
            };
        };

        // Session content placeholder
        const sessionContent = {
            1: { title: "Brain Health Fundamentals", modules: [] },
            2: { title: "Understanding MCI & Early Warning Signs", modules: [] },
            3: { title: "Cognitive Strategies & Treatment", modules: [] },
            4: { title: "Mood, Mental Health & Brain Protection", modules: [] },
            5: { title: "Relaxation, Stress & Sleep", modules: [] },
            6: { title: "Lifestyle Management", modules: [] },
            7: { title: "Cognitive Training & Moving Forward", modules: [] }
        };

        // Global state variables
        let messages = [];
        let currentSession = null;
        let currentModule = 0;
        let currentSegment = 0;
        let awaitingResponse = false;
        let userProfile = diagnosticProfile;
        let sessionPhase = 'intro';
        let baselineResponses = {};
        let showProgress = false;
        let activeExercise = null;
        let exerciseState = {};
        let answerOptions = null;
        let showUserDropdown = false;
        let availableUsers = [];
        let currentUser = 'user1';
        let sessionStartTime = null;

        // Session data
        const sessions = [
            { id: 1, title: "Brain Health Fundamentals", unlocked: true },
            { id: 2, title: "Understanding MCI & Early Warning Signs", unlocked: true },
            { id: 3, title: "Cognitive Strategies & Treatment", unlocked: true },
            { id: 4, title: "Mood, Mental Health & Brain Protection", unlocked: true },
            { id: 5, title: "Relaxation, Stress & Sleep", unlocked: true },
            { id: 6, title: "Lifestyle Management", unlocked: true },
            { id: 7, title: "Cognitive Training & Moving Forward", unlocked: true }
        ];

        // About Me logging functions
        function logAssessmentResponse(sessionId, questionIndex, questionText, response, questionType) {
            const profileRef = currentUser === 'user1' ? diagnosticProfile : getUserProfile(currentUser);

            if (!profileRef.aboutMe) {
                profileRef.aboutMe = createDefaultAboutMe();
            }

            if (!profileRef.aboutMe.assessmentResponses) {
                profileRef.aboutMe.assessmentResponses = {
                    bySession: {},
                    knowledgeProgression: { familiarity: [], confidence: [], readiness: [] },
                    improvementMetrics: { familiarityTrend: null, confidenceTrend: null, averageImprovement: 0 }
                };
            }

            if (!profileRef.aboutMe.assessmentResponses.bySession[sessionId]) {
                profileRef.aboutMe.assessmentResponses.bySession[sessionId] = [];
            }

            const responseRecord = {
                sessionId: sessionId,
                sessionTitle: sessions.find(s => s.id === sessionId)?.title || 'Unknown Session',
                questionIndex: questionIndex,
                questionText: questionText,
                questionType: questionType,
                response: response,
                numericValue: extractNumericValue(response, questionType),
                timestamp: new Date().toISOString(),
                attemptNumber: getAttemptNumber(profileRef, sessionId)
            };

            profileRef.aboutMe.assessmentResponses.bySession[sessionId].push(responseRecord);
            updateKnowledgeProgression(profileRef, responseRecord);
            analyzeKnowledgeTrends(profileRef);

            saveUserProfile(profileRef);
        }

        function extractNumericValue(response, questionType) {
            if (questionType === 'readiness') {
                return response.toLowerCase() === 'yes' ? 1 : 0;
            }
            const match = response.match(/^(\d)/);
            return match ? parseInt(match[1]) : null;
        }

        function getAttemptNumber(profile, sessionId) {
            if (!profile.aboutMe?.assessmentResponses?.bySession[sessionId]) {
                return 1;
            }
            const uniqueDates = new Set(
                profile.aboutMe.assessmentResponses.bySession[sessionId]
                    .map(r => new Date(r.timestamp).toDateString())
            );
            return uniqueDates.size + 1;
        }

        function updateKnowledgeProgression(profile, responseRecord) {
            const progressionData = {
                sessionId: responseRecord.sessionId,
                value: responseRecord.numericValue,
                timestamp: responseRecord.timestamp,
                attemptNumber: responseRecord.attemptNumber
            };

            switch(responseRecord.questionType) {
                case 'familiarity':
                    profile.aboutMe.assessmentResponses.knowledgeProgression.familiarity.push(progressionData);
                    break;
                case 'confidence':
                    profile.aboutMe.assessmentResponses.knowledgeProgression.confidence.push(progressionData);
                    break;
                case 'readiness':
                    profile.aboutMe.assessmentResponses.knowledgeProgression.readiness.push(progressionData);
                    break;
            }
        }

        function analyzeKnowledgeTrends(profile) {
            const assessments = profile.aboutMe.assessmentResponses;
            assessments.improvementMetrics.familiarityTrend = calculateTrend(
                assessments.knowledgeProgression.familiarity
            );
            assessments.improvementMetrics.confidenceTrend = calculateTrend(
                assessments.knowledgeProgression.confidence
            );
            assessments.improvementMetrics.averageImprovement = calculateAverageImprovement(
                assessments.knowledgeProgression
            );
        }

        function calculateTrend(progressionArray) {
            if (progressionArray.length < 2) return "insufficient_data";

            const sorted = [...progressionArray].sort((a, b) =>
                new Date(a.timestamp) - new Date(b.timestamp)
            );

            const thirdSize = Math.floor(sorted.length / 3);
            if (thirdSize === 0) return "insufficient_data";

            const firstThird = sorted.slice(0, thirdSize);
            const lastThird = sorted.slice(-thirdSize);

            const firstAvg = firstThird.reduce((sum, item) => sum + (item.value || 0), 0) / firstThird.length;
            const lastAvg = lastThird.reduce((sum, item) => sum + (item.value || 0), 0) / lastThird.length;

            const difference = lastAvg - firstAvg;

            if (difference > 0.5) return "improving";
            if (difference < -0.5) return "declining";
            return "stable";
        }

        function calculateAverageImprovement(knowledgeProgression) {
            let totalImprovement = 0;
            let metricCount = 0;

            ['familiarity', 'confidence'].forEach(metric => {
                const data = knowledgeProgression[metric];
                if (data.length >= 2) {
                    const sorted = [...data].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    const first = sorted[0].value || 0;
                    const last = sorted[sorted.length - 1].value || 0;
                    totalImprovement += ((last - first) / first) * 100;
                    metricCount++;
                }
            });

            return metricCount > 0 ? Math.round(totalImprovement / metricCount) : 0;
        }

        function logLessonCompletion(sessionId, baselineResponses, exerciseResults) {
            const profileRef = currentUser === 'user1' ? diagnosticProfile : getUserProfile(currentUser);

            if (!profileRef.aboutMe) {
                profileRef.aboutMe = createDefaultAboutMe();
            }

            if (!profileRef.aboutMe.lessonsCompleted) {
                profileRef.aboutMe.lessonsCompleted = {
                    sessions: [],
                    totalCompleted: 0,
                    lastCompletedDate: null,
                    completionRate: 0
                };
            }

            const session = sessions.find(s => s.id === sessionId);
            const completionRecord = {
                sessionId: sessionId,
                sessionTitle: session?.title || 'Unknown Session',
                completedAt: new Date().toISOString(),
                duration: calculateSessionDuration(),
                baselineScores: {
                    familiarity: baselineResponses.question_0 || null,
                    confidence: baselineResponses.question_1 || null,
                    readiness: baselineResponses.question_2 || null
                },
                exercisesCompleted: exerciseResults?.length || 0,
                retakeNumber: getSessionRetakeNumber(profileRef, sessionId),
                concernsAddressed: identifyConcernsAddressedBySession(profileRef, sessionId),
                bestLifeElementsSupported: identifyBestLifeElementsSupported(profileRef, sessionId)
            };

            profileRef.aboutMe.lessonsCompleted.sessions.push(completionRecord);

            const uniqueSessions = new Set(
                profileRef.aboutMe.lessonsCompleted.sessions.map(s => s.sessionId)
            );
            profileRef.aboutMe.lessonsCompleted.totalCompleted = uniqueSessions.size;
            profileRef.aboutMe.lessonsCompleted.lastCompletedDate = completionRecord.completedAt;
            profileRef.aboutMe.lessonsCompleted.completionRate =
                Math.round((uniqueSessions.size / sessions.length) * 100);

            saveUserProfile(profileRef);
            generateCompletionInsights(profileRef, completionRecord);
        }

        function getSessionRetakeNumber(profile, sessionId) {
            if (!profile.aboutMe?.lessonsCompleted?.sessions) return 1;
            const previousCompletions = profile.aboutMe.lessonsCompleted.sessions
                .filter(s => s.sessionId === sessionId);
            return previousCompletions.length + 1;
        }

        function identifyConcernsAddressedBySession(profile, sessionId) {
            const addressedConcerns = [];
            if (!profile.aboutMe?.concerns) return addressedConcerns;

            const sessionConcernMap = {
                1: ['cognitive changes', 'brain health understanding'],
                2: ['memory changes', 'early warning signs'],
                3: ['financial management', 'navigation', 'daily activities'],
                4: ['anxiety', 'mood changes', 'depression'],
                5: ['sleep patterns', 'stress management'],
                6: ['physical activity', 'social isolation', 'diet'],
                7: ['cognitive training', 'long-term planning']
            };

            const sessionConcerns = sessionConcernMap[sessionId] || [];

            profile.aboutMe.concerns.forEach(concern => {
                const concernLower = concern.concern.toLowerCase();
                if (sessionConcerns.some(sc => concernLower.includes(sc))) {
                    addressedConcerns.push(concern.concern);
                }
            });

            return addressedConcerns;
        }

        function identifyBestLifeElementsSupported(profile, sessionId) {
            const supportedElements = [];
            if (!profile.aboutMe?.bestLifeElements) return supportedElements;

            const sessionElementMap = {
                1: ['mental stimulation', 'understanding'],
                2: ['independence', 'daily needs'],
                3: ['independence', 'daily needs', 'finances'],
                4: ['mental health', 'wellbeing'],
                5: ['health', 'rest', 'relaxation'],
                6: ['exercise', 'social activities', 'hobbies'],
                7: ['mental stimulation', 'planning', 'goals']
            };

            const sessionElements = sessionElementMap[sessionId] || [];

            profile.aboutMe.bestLifeElements.forEach(element => {
                const elementLower = element.element.toLowerCase();
                if (sessionElements.some(se => elementLower.includes(se))) {
                    supportedElements.push(element.element);
                }
            });

            return supportedElements;
        }

        function calculateSessionDuration() {
            if (!sessionStartTime) return null;
            const duration = Date.now() - sessionStartTime;
            return Math.round(duration / 60000);
        }

        function generateCompletionInsights(profile, completionRecord) {
            let insights = [];

            if (completionRecord.retakeNumber > 1) {
                const previousAttempt = profile.aboutMe.lessonsCompleted.sessions
                    .filter(s => s.sessionId === completionRecord.sessionId)
                    .slice(-2)[0];

                if (previousAttempt) {
                    const prevFamiliarity = parseInt(previousAttempt.baselineScores.familiarity) || 0;
                    const currFamiliarity = parseInt(completionRecord.baselineScores.familiarity) || 0;

                    if (currFamiliarity > prevFamiliarity) {
                        insights.push(`Your familiarity improved from ${prevFamiliarity} to ${currFamiliarity}!`);
                    }

                    const prevConfidence = parseInt(previousAttempt.baselineScores.confidence) || 0;
                    const currConfidence = parseInt(completionRecord.baselineScores.confidence) || 0;

                    if (currConfidence > prevConfidence) {
                        insights.push(`Your confidence increased from ${prevConfidence} to ${currConfidence}!`);
                    }
                }
            }

            if (completionRecord.concernsAddressed.length > 0) {
                insights.push(`This session addressed your concerns about: ${completionRecord.concernsAddressed.join(', ')}`);
            }

            if (completionRecord.bestLifeElementsSupported.length > 0) {
                insights.push(`This session supports what matters most to you: ${completionRecord.bestLifeElementsSupported.join(', ')}`);
            }

            if (insights.length > 0) {
                setTimeout(() => {
                    addBotMessage(
                        `üìä **Session Insights:**\n\n${insights.join('\n\n')}\n\n` +
                        `Your progress is being tracked in your About Me profile!`
                    );
                }, 2000);
            }
        }

        function logBestLifeElement(element, priority = 1, sessionContext = null) {
            const profileRef = currentUser === 'user1' ? diagnosticProfile : getUserProfile(currentUser);

            if (!profileRef.aboutMe) {
                profileRef.aboutMe = createDefaultAboutMe();
            }

            profileRef.aboutMe.bestLifeElements.push({
                element: element,
                priority: priority,
                timestamp: new Date().toISOString(),
                identifiedIn: sessionContext ? `Session ${sessionContext.sessionId}` : 'conversation'
            });

            updateAboutMeCompleteness(profileRef);
            saveUserProfile(profileRef);
        }

        function logConcern(concern, severity = 'moderate', context = '') {
            const profileRef = currentUser === 'user1' ? diagnosticProfile : getUserProfile(currentUser);

            if (!profileRef.aboutMe) {
                profileRef.aboutMe = createDefaultAboutMe();
            }

            profileRef.aboutMe.concerns.push({
                concern: concern,
                severity: severity,
                timestamp: new Date().toISOString(),
                context: context
            });

            updateAboutMeCompleteness(profileRef);
            saveUserProfile(profileRef);
        }

        function updateAboutMeCompleteness(profile) {
            let completeness = 0;
            if (profile.aboutMe.bestLifeElements.length > 0) completeness += 40;
            if (profile.aboutMe.concerns.length > 0) completeness += 40;
            if (profile.aboutMe.confidenceLevel) completeness += 20;
            profile.aboutMe.profileCompleteness = completeness;
        }

        function saveUserProfile(profile) {
            localStorage.setItem(`brainHealth_${profile.userId}`, JSON.stringify(profile));
        }

        function getUserProfile(userId) {
            const saved = localStorage.getItem(`brainHealth_${userId}`);
            if (saved) {
                return JSON.parse(saved);
            }
            return createDefaultUserHistory();
        }

        function createDefaultAboutMe() {
            return {
                bestLifeElements: [],
                concerns: [],
                confidenceLevel: "",
                confidenceTimestamp: null,
                profileCompleteness: 0,
                lastUpdated: null,
                lessonsCompleted: {
                    sessions: [],
                    totalCompleted: 0,
                    lastCompletedDate: null,
                    completionRate: 0
                },
                assessmentResponses: {
                    bySession: {},
                    knowledgeProgression: {
                        familiarity: [],
                        confidence: [],
                        readiness: []
                    },
                    improvementMetrics: {
                        familiarityTrend: null,
                        confidenceTrend: null,
                        averageImprovement: 0
                    }
                }
            };
        }

        // Display functions for About Me sections
        function displayLessonsCompleted(profile) {
            if (!profile.aboutMe?.lessonsCompleted) return "";

            const completed = profile.aboutMe.lessonsCompleted;
            let display = `<strong>Progress:</strong> ${completed.totalCompleted}/${sessions.length} sessions (${completed.completionRate}%)<br><br>`;

            if (completed.sessions.length > 0) {
                const recent = completed.sessions.slice(-3).reverse();
                display += "<strong>Recent Sessions:</strong><br>";

                recent.forEach(session => {
                    display += `<div class="session-completion">`;
                    display += `<div class="completion-header">${session.sessionTitle}</div>`;
                    display += `<div class="completion-details">`;
                    display += `Completed: ${new Date(session.completedAt).toLocaleDateString()}<br>`;

                    if (session.retakeNumber > 1) {
                        display += `Attempt #${session.retakeNumber}<br>`;
                    }

                    if (session.concernsAddressed.length > 0) {
                        display += `‚úì Addressed: ${session.concernsAddressed.join(', ')}<br>`;
                    }

                    display += `Baseline: Familiarity ${session.baselineScores.familiarity || 'N/A'}/5, `;
                    display += `Confidence ${session.baselineScores.confidence || 'N/A'}/5`;
                    display += `</div></div>`;
                });
            }

            return display;
        }

        function displayAssessmentProgress(profile) {
            if (!profile.aboutMe?.assessmentResponses) return "";

            const responses = profile.aboutMe.assessmentResponses;
            let display = "";

            if (responses.improvementMetrics.averageImprovement !== 0) {
                display += `<strong>Overall Improvement:</strong> ${responses.improvementMetrics.averageImprovement}%<br>`;
            }

            if (responses.improvementMetrics.familiarityTrend) {
                const trendEmoji = {
                    'improving': 'üìà',
                    'stable': '‚û°Ô∏è',
                    'declining': 'üìâ',
                    'insufficient_data': '‚ùì'
                };

                display += `<div class="assessment-trend">`;
                display += `<span class="trend-emoji">${trendEmoji[responses.improvementMetrics.familiarityTrend]}</span>`;
                display += `<strong>Familiarity:</strong> ${responses.improvementMetrics.familiarityTrend}`;
                display += `</div>`;

                display += `<div class="assessment-trend">`;
                display += `<span class="trend-emoji">${trendEmoji[responses.improvementMetrics.confidenceTrend]}</span>`;
                display += `<strong>Confidence:</strong> ${responses.improvementMetrics.confidenceTrend}`;
                display += `</div>`;
            }

            const sessionImprovements = calculateSessionSpecificImprovements(profile);
            if (sessionImprovements.length > 0) {
                display += "<br><strong>Session Improvements:</strong><br>";
                sessionImprovements.forEach(improvement => {
                    display += `‚Ä¢ ${improvement.sessionTitle}: `;
                    display += `Familiarity ${improvement.familiarityChange}, `;
                    display += `Confidence ${improvement.confidenceChange}<br>`;
                });
            }

            return display;
        }

        function calculateSessionSpecificImprovements(profile) {
            const improvements = [];

            if (!profile.aboutMe?.assessmentResponses?.bySession) return improvements;

            Object.entries(profile.aboutMe.assessmentResponses.bySession).forEach(([sessionId, responses]) => {
                const byAttempt = {};
                responses.forEach(response => {
                    if (!byAttempt[response.attemptNumber]) {
                        byAttempt[response.attemptNumber] = [];
                    }
                    byAttempt[response.attemptNumber].push(response);
                });

                const attempts = Object.keys(byAttempt).sort((a, b) => parseInt(a) - parseInt(b));

                if (attempts.length >= 2) {
                    const firstAttempt = byAttempt[attempts[0]];
                    const lastAttempt = byAttempt[attempts[attempts.length - 1]];

                    const firstFamiliarity = firstAttempt.find(r => r.questionType === 'familiarity')?.numericValue || 0;
                    const lastFamiliarity = lastAttempt.find(r => r.questionType === 'familiarity')?.numericValue || 0;

                    const firstConfidence = firstAttempt.find(r => r.questionType === 'confidence')?.numericValue || 0;
                    const lastConfidence = lastAttempt.find(r => r.questionType === 'confidence')?.numericValue || 0;

                    improvements.push({
                        sessionId: sessionId,
                        sessionTitle: sessions.find(s => s.id === parseInt(sessionId))?.title || 'Unknown',
                        familiarityChange: `${firstFamiliarity} ‚Üí ${lastFamiliarity}`,
                        confidenceChange: `${firstConfidence} ‚Üí ${lastConfidence}`,
                        improvement: (lastFamiliarity - firstFamiliarity) + (lastConfidence - firstConfidence)
                    });
                }
            });

            return improvements.sort((a, b) => b.improvement - a.improvement);
        }

        function updateAboutMeSummary() {
            const summary = document.getElementById('aboutMeSummary');
            const content = document.getElementById('aboutMeContent');

            if (!userProfile.aboutMe || userProfile.aboutMe.profileCompleteness === 0) {
                summary.style.display = 'none';
                return;
            }

            summary.style.display = 'block';
            content.innerHTML = '';

            if (userProfile.aboutMe.bestLifeElements.length > 0) {
                userProfile.aboutMe.bestLifeElements.forEach(element => {
                    const div = document.createElement('div');
                    div.className = 'about-me-item best-life';
                    div.innerHTML = `<span>üåü</span> ${element.element}`;
                    content.appendChild(div);
                });
            }

            if (userProfile.aboutMe.concerns.length > 0) {
                userProfile.aboutMe.concerns.forEach(concern => {
                    const div = document.createElement('div');
                    div.className = 'about-me-item concern';
                    div.innerHTML = `<span>ü§î</span> ${concern.concern}`;
                    content.appendChild(div);
                });
            }

            if (userProfile.aboutMe.confidenceLevel) {
                const div = document.createElement('div');
                div.style.marginTop = '10px';
                div.innerHTML = `<strong>Confidence Level:</strong> ${userProfile.aboutMe.confidenceLevel}`;
                content.appendChild(div);
            }
        }

        // UI State Management
        function setShowProgress(value) {
            showProgress = value;
            const dashboard = document.getElementById('progressDashboard');
            dashboard.style.display = value ? 'flex' : 'none';

            if (value) {
                updateProgressDisplay();
            }
        }

        function setShowUserDropdown(value) {
            showUserDropdown = value;
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = value ? 'block' : 'none';
        }

        function updateProgressDisplay() {
            updateAboutMeSummary();

            const lessonsContent = document.getElementById('lessonsCompletedContent');
            const assessmentContent = document.getElementById('assessmentProgressContent');

            lessonsContent.innerHTML = displayLessonsCompleted(userProfile);
            assessmentContent.innerHTML = displayAssessmentProgress(userProfile);

            const progressGrid = document.getElementById('progressGrid');
            progressGrid.innerHTML = `
                <div class="progress-card">
                    <h3>Session Completion</h3>
                    <div class="chart-container">Session chart visualization would go here</div>
                </div>
                <div class="progress-card">
                    <h3>Knowledge Trends</h3>
                    <div class="chart-container">Knowledge progression chart would go here</div>
                </div>
            `;
        }

        // Message handling
        function addBotMessage(text, type = 'general') {
            const newMessage = {
                id: Date.now(),
                sender: 'bot',
                text,
                type,
                timestamp: new Date()
            };
            messages.push(newMessage);
            renderMessages();
        }

        function addUserMessage(text) {
            const newMessage = {
                id: Date.now(),
                sender: 'user',
                text,
                timestamp: new Date()
            };
            messages.push(newMessage);
            renderMessages();
        }

        function renderMessages() {
            const container = document.getElementById('chatContainer');
            const typingIndicator = document.getElementById('typingIndicator');

            container.innerHTML = '';

            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';

                const messageContent = document.createElement('div');
                messageContent.className = message.sender === 'bot' ? 'bot-message' : 'user-message';

                if (message.type === 'session_menu' && message.sender === 'bot') {
                    messageContent.innerHTML = renderSessionMenu();
                } else {
                    messageContent.innerHTML = message.text.replace(/\n/g, '<br>');
                }

                messageDiv.appendChild(messageContent);
                container.appendChild(messageDiv);
            });

            container.appendChild(typingIndicator);
            scrollToBottom();
        }

        function renderSessionMenu() {
            let html = '<div class="session-menu">';

            sessions.forEach(session => {
                const isCompleted = userProfile.completedSessions.includes(session.id);
                let hint = '';

                if (userProfile.diagnosis?.includes("MCI")) {
                    if (session.id === 2) hint = "Recommended: Learn about your MCI diagnosis";
                    if (session.id === 3 && userProfile.current_symptoms?.instrumental_activities_daily_living?.managing_finances) {
                        hint = "Recommended: Strategies for your specific challenges";
                    }
                }

                html += `
                    <div class="session-card" onclick="startSession(${session.id})">
                        <div class="session-info">
                            <div class="session-title">Session ${session.id}: ${session.title}</div>
                            ${hint ? `<div class="session-hint">‚ö†Ô∏è ${hint}</div>` : ''}
                        </div>
                        ${isCompleted ? '<span class="completed-icon">‚úì</span>' : ''}
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        function scrollToBottom() {
            const container = document.getElementById('chatContainer');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'none';
        }

        function setAnswerOptions(options) {
            answerOptions = options;
            const answerDiv = document.getElementById('answerOptions');
            const buttonsDiv = document.getElementById('answerButtons');

            if (options && options.length > 0) {
                answerDiv.style.display = 'block';
                buttonsDiv.innerHTML = '';

                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'answer-button';
                    if (option.includes("Other") || option.includes("text box")) {
                        button.className += ' other';
                    }
                    button.textContent = option;
                    button.onclick = () => handleAnswerButtonClick(option);
                    buttonsDiv.appendChild(button);
                });
            } else {
                answerDiv.style.display = 'none';
            }
        }

        // Session Management
        function startSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            currentSession = session;
            currentModule = 0;
            currentSegment = 0;
            sessionPhase = 'baseline';
            baselineResponses = {};
            setAnswerOptions(null);
            sessionStartTime = Date.now();

            let startMessage = `Great! Let's begin Session ${session.id}: ${session.title}.`;

            if (userProfile.diagnosis?.includes("MCI")) {
                switch(sessionId) {
                    case 2:
                        startMessage += `\n\nThis session is particularly relevant for you as someone living with MCI.`;
                        break;
                    case 3:
                        startMessage += `\n\nWe'll focus on practical strategies for your challenges.`;
                        break;
                }
            }

            startMessage += `\n\nBefore we dive in, I'd like to ask a few questions to tailor this session to your needs.`;

            addBotMessage(startMessage);

            const questions = getPersonalizedBaselineQuestions(sessionId, userProfile);
            const firstQuestion = questions[0];

            setTimeout(() => {
                addBotMessage(`${firstQuestion.question}\n\n${firstQuestion.scale}`);
                awaitingResponse = { type: 'baseline', questionIndex: 0 };
                setAnswerOptions(['1', '2', '3', '4', '5', "Other - I'll submit my message in the text box below."]);
            }, 2000);
        }

        function handleBaselineResponse(response, questionIndex) {
            const questions = getPersonalizedBaselineQuestions(currentSession?.id, userProfile);
            const currentQuestion = questions[questionIndex];

            // Determine question type
            let questionType = 'other';
            if (currentQuestion.question.toLowerCase().includes('familiar')) {
                questionType = 'familiarity';
            } else if (currentQuestion.question.toLowerCase().includes('confident')) {
                questionType = 'confidence';
            } else if (currentQuestion.question.toLowerCase().includes('ready')) {
                questionType = 'readiness';
            }

            // Log the assessment response
            logAssessmentResponse(
                currentSession.id,
                questionIndex,
                currentQuestion.question,
                response,
                questionType
            );

            // Save the response
            baselineResponses[`question_${questionIndex}`] = response;

            // Check if there are more questions
            if (questionIndex < questions.length - 1) {
                setTimeout(() => {
                    const nextQuestion = questions[questionIndex + 1];
                    addBotMessage(`${nextQuestion.question}${nextQuestion.scale ? '\n\n' + nextQuestion.scale : ''}`);
                    awaitingResponse = { type: 'baseline', questionIndex: questionIndex + 1 };

                    if (questionIndex + 1 === 2) {
                        setAnswerOptions(['Yes', 'No', "I'll be back"]);
                    } else if (nextQuestion.scale.includes('1') && nextQuestion.scale.includes('5')) {
                        setAnswerOptions(['1', '2', '3', '4', '5', "Other - I'll submit my message in the text box below."]);
                    } else {
                        setAnswerOptions(null);
                    }
                }, 1000);
            } else {
                // Check About Me completeness after baseline questions
                if (response.toLowerCase() === 'yes') {
                    const profileRef = currentUser === 'user1' ? diagnosticProfile : getUserProfile(currentUser);

                    if (!profileRef.aboutMe || profileRef.aboutMe.profileCompleteness < 100) {
                        setTimeout(() => {
                            showAboutMeDiscovery();
                        }, 1500);
                    } else {
                        setAnswerOptions(null);
                        startSessionContent();
                    }
                } else if (response.toLowerCase() === 'no') {
                    addBotMessage("That's okay. Take your time. When you're ready, you can return to start the session.");
                    awaitingResponse = null;
                    setAnswerOptions(null);
                } else if (response.toLowerCase().includes("i'll be back")) {
                    addBotMessage("No problem! I'll save your progress. When you return, we can pick up right where we left off.");
                    awaitingResponse = null;
                    setAnswerOptions(null);
                }
            }
        }

        function showAboutMeDiscovery() {
            addBotMessage(
                "Before we dive into the content, I'd like to understand what matters most to you. " +
                "This helps me personalize your brain health journey.\n\n" +
                "When you think about living your best life despite brain health challenges, what brings you the most meaning?"
            );

            const bestLifeOptions = [
                "Spending time with loved ones",
                "Maintaining independence",
                "Continuing my hobbies",
                "Helping others",
                "Learning new things",
                "Staying physically active"
            ];

            awaitingResponse = { type: 'about_me_best_life' };
            setAnswerOptions(bestLifeOptions);
        }

        function startSessionContent() {
            sessionPhase = 'content';
            setAnswerOptions(null);
            currentSegment = 0;
            currentModule = 0;

            const familiarity = parseInt(baselineResponses.question_0) || 3;
            const confidence = parseInt(baselineResponses.question_1) || 3;

            let introMessage = `Thank you for your responses! `;
            introMessage += `Based on your familiarity level (${familiarity}/5) and confidence (${confidence}/5), `;
            introMessage += `I'll tailor this session to your needs.\n\n`;
            introMessage += `Let's begin with the first topic.`;

            addBotMessage(introMessage);

            setTimeout(() => showNextModule(), 1500);
        }

        function showNextModule() {
            if (!currentSession) return;

            const content = getPersonalizedContent(currentSession.id, userProfile) || sessionContent[currentSession.id];

            if (!content || !content.modules || currentModule >= content.modules.length) {
                completeSession();
                return;
            }

            const module = content.modules[currentModule];

            switch (module.type) {
                case 'content':
                    setCurrentSegment(0);
                    showContentSegment(module);
                    break;
                case 'quiz':
                    startQuiz(module);
                    break;
                case 'exercise':
                    startExercise(module);
                    break;
                default:
                    setCurrentSegment(0);
                    showContentSegment(module);
            }
        }

        function showContentSegment(module) {
            if (!module || !module.segments || module.segments.length === 0) {
                addBotMessage("Let's continue with the training.");
                awaitingResponse = { type: 'continue_content' };
                setTimeout(() => {
                    addBotMessage("Ready to continue?");
                    setAnswerOptions(['Yes', 'Continue']);
                }, 1000);
                return;
            }

            proceedWithSegment(module);
        }

        function proceedWithSegment(module) {
            if (!module || !module.segments) return;

            if (currentSegment >= module.segments.length) {
                currentSegment = 0;
                currentModule++;
                addBotMessage("Great job completing this section! Let's move on to the next part.");
                setTimeout(() => showNextModule(), 1500);
                return;
            }

            const segment = module.segments[currentSegment];
            addBotMessage(segment.content);

            if (segment.discussion) {
                setTimeout(() => {
                    addBotMessage(segment.discussion);
                    awaitingResponse = { type: 'segment_discussion' };

                    if (segment.discussionOptions) {
                        setAnswerOptions(segment.discussionOptions);
                    } else {
                        setAnswerOptions(['Continue', 'Tell me more', 'I have a question']);
                    }
                }, 2500);
            } else {
                setTimeout(() => {
                    addBotMessage("Ready to continue?");
                    awaitingResponse = { type: 'continue_segment' };
                    setAnswerOptions(['Yes', 'Continue']);
                }, 2000);
            }
        }

        function completeSession() {
            const sessionId = currentSession.id;

            // Log lesson completion
            logLessonCompletion(
                sessionId,
                baselineResponses,
                userProfile.exerciseResults?.filter(e => e.sessionId === sessionId) || []
            );

            userProfile.completedSessions = [...new Set([...userProfile.completedSessions, sessionId])];
            userProfile.sessionScores[sessionId] = {
                baseline: baselineResponses,
                completedAt: new Date()
            };

            saveUserProfile(userProfile);

            let completionMessage = `üéâ Congratulations! You've completed Session ${sessionId}: ${currentSession.title}!`;
            completionMessage += `\n\nYour progress has been saved.`;

            addBotMessage(completionMessage);
            setAnswerOptions(null);

            setTimeout(() => {
                addBotMessage("Would you like to continue with another session?");
                setTimeout(() => {
                    addBotMessage("", 'session_menu');
                    awaitingResponse = { type: 'session_select' };
                }, 500);
            }, 2000);

            currentSession = null;
        }

        function startQuiz(module) {
            exerciseState = { currentQuestion: 0, score: 0, answers: [] };
            setAnswerOptions(null);
            addBotMessage(`Let's check your understanding with a quick quiz: **${module.title}**`);
            setTimeout(() => askQuizQuestion(module, 0), 1000);
        }

        function askQuizQuestion(module, index) {
            if (!module.questions || index >= module.questions.length) {
                const score = exerciseState.score;
                const total = module.questions?.length || 0;
                addBotMessage(`Quiz complete! You got ${score} out of ${total} correct.`);

                exerciseState = {};
                setAnswerOptions(null);
                currentModule++;
                setTimeout(() => showNextModule(), 2000);
                return;
            }

            const question = module.questions[index];
            const optionsText = question.options.map((opt, i) => `${i + 1}. ${opt}`).join('\n');

            addBotMessage(`${question.question}\n\n${optionsText}`);
            awaitingResponse = { type: 'quiz', module, questionIndex: index };

            const quizButtons = question.options.map((_, i) => `${i + 1}`);
            setAnswerOptions(quizButtons);
        }

        function handleQuizResponse(response) {
            const { module, questionIndex } = awaitingResponse;
            const question = module.questions[questionIndex];
            const userAnswer = parseInt(response) - 1;

            const isCorrect = userAnswer === question.correct;
            exerciseState.score += isCorrect ? 1 : 0;

            let feedback = isCorrect ? "‚úÖ Correct! " : `‚ùå Not quite. The correct answer was: ${question.options[question.correct]}. `;
            if (question.explanation) {
                feedback += question.explanation;
            }

            addBotMessage(feedback);
            setTimeout(() => askQuizQuestion(module, questionIndex + 1), 2000);
        }

        function startExercise(module) {
            activeExercise = module;
            setAnswerOptions(null);
            addBotMessage(`Let's practice: **${module.title}**\n\n${module.description}`);
            awaitingResponse = { type: 'exercise', module };
        }

        function handleExerciseResponse(response) {
            addBotMessage("Great job completing the exercise!");
            activeExercise = null;
            setAnswerOptions(null);
            currentModule++;
            setTimeout(() => showNextModule(), 1500);
        }

        // Input handling
        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();

            if (message) {
                addUserMessage(message);
                input.value = '';
                processUserResponse(message);
            }
        }

        function handleAnswerButtonClick(answer) {
            if (answer.includes("Other") || answer.includes("text box")) {
                return;
            }

            addUserMessage(answer);
            processUserResponse(answer);
        }

        function processUserResponse(response) {
            if (!awaitingResponse) {
                if (response.toLowerCase().includes('session') || response.toLowerCase().includes('start')) {
                    showSessionMenu();
                } else if (response.toLowerCase().includes('progress')) {
                    setShowProgress(true);
                } else {
                    addBotMessage("I can help you start a session or view your progress. You can type 'session' to see available sessions.");
                }
                return;
            }

            const { type, questionIndex } = awaitingResponse;

            switch (type) {
                case 'welcome':
                    handleWelcomeResponse(response);
                    break;
                case 'baseline':
                    handleBaselineResponse(response, questionIndex);
                    break;
                case 'about_me_best_life':
                    handleAboutMeBestLife(response);
                    break;
                case 'about_me_concerns':
                    handleAboutMeConcerns(response);
                    break;
                case 'about_me_confidence':
                    handleAboutMeConfidence(response);
                    break;
                case 'continue_content':
                case 'continue_segment':
                    if (response.toLowerCase().includes('yes') || response.toLowerCase().includes('continue')) {
                        setAnswerOptions(null);
                        currentModule++;
                        showNextModule();
                    }
                    break;
                case 'segment_discussion':
                    handleSegmentResponse(response);
                    break;
                case 'quiz':
                    handleQuizResponse(response);
                    break;
                case 'exercise':
                    handleExerciseResponse(response);
                    break;
                default:
                    addBotMessage("I didn't quite understand that. Could you please rephrase?");
            }
        }

        function handleWelcomeResponse(response) {
            if (response.toLowerCase().includes('yes') || response.toLowerCase().includes('session')) {
                showSessionMenu();
            } else if (response.toLowerCase().includes('tell me more')) {
                addBotMessage(
                    "This program offers 7 comprehensive sessions, each with specific goals:\n\n" +
                    "**Session 1: Brain Health Fundamentals**\n" +
                    "Purpose: Understand what happens to your brain during normal aging and learn to optimize your cognitive health.\n" +
                    "Goals: ‚Ä¢ Distinguish normal aging from concerning changes ‚Ä¢ Learn about neuroplasticity and cognitive reserve ‚Ä¢ Build foundation for brain health optimization\n\n" +
                    "**Session 2: Understanding MCI & Early Warning Signs**\n" +
                    "Purpose: Recognize early cognitive changes and understand what an MCI diagnosis means for your daily life.\n" +
                    "Goals: ‚Ä¢ Identify early warning signs of cognitive changes ‚Ä¢ Understand your MCI diagnosis ‚Ä¢ Learn when to seek help and communicate concerns\n\n" +
                    "**Session 3: Cognitive Strategies & Treatment**\n" +
                    "Purpose: Implement practical strategies for daily challenges and make informed decisions about treatments.\n" +
                    "Goals: ‚Ä¢ Master compensatory strategies for memory and daily tasks ‚Ä¢ Understand current treatment options ‚Ä¢ Address specific challenges like financial management\n\n" +
                    "**Session 4: Mood, Mental Health & Brain Protection**\n" +
                    "Purpose: Understand how mood and mental health directly impact your cognitive function.\n" +
                    "Goals: ‚Ä¢ Recognize mood-cognition connections ‚Ä¢ Learn mood management techniques ‚Ä¢ Develop strategies to protect cognitive health through emotional wellness\n\n" +
                    "**Session 5: Relaxation, Stress & Sleep**\n" +
                    "Purpose: Master stress management and sleep optimization for better brain health.\n" +
                    "Goals: ‚Ä¢ Practice evidence-based relaxation techniques ‚Ä¢ Improve sleep quality and patterns ‚Ä¢ Reduce stress impact on cognitive function\n\n" +
                    "**Session 6: Lifestyle Management**\n" +
                    "Purpose: Create a brain-healthy lifestyle through exercise, nutrition, and social engagement.\n" +
                    "Goals: ‚Ä¢ Design personalized exercise routine ‚Ä¢ Adopt brain-healthy diet ‚Ä¢ Strengthen social connections and activities\n\n" +
                    "**Session 7: Cognitive Training & Moving Forward**\n" +
                    "Purpose: Build a comprehensive long-term brain health program with cognitive training.\n" +
                    "Goals: ‚Ä¢ Master cognitive training exercises ‚Ä¢ Create personalized action plan ‚Ä¢ Establish sustainable brain health habits\n\n" +
                    "Each session is personalized based on your assessment results and includes interactive exercises.\n\n" +
                    "Would you like to see the available sessions?"
                );
                awaitingResponse = { type: 'welcome' };
                setAnswerOptions(['Yes, show me the sessions']);
            }
        }

        function handleAboutMeBestLife(response) {
            logBestLifeElement(response, 1, { sessionId: currentSession?.id });

            addBotMessage(
                `That's wonderful! ${response} is clearly important to you.\n\n` +
                `Now, what concerns you most when thinking about maintaining this?`
            );

            const concernOptions = [
                "Memory changes",
                "Managing daily tasks",
                "Staying independent",
                "Financial management",
                "Mood or anxiety",
                "Physical health"
            ];

            awaitingResponse = { type: 'about_me_concerns' };
            setAnswerOptions(concernOptions);
        }

        function handleAboutMeConcerns(response) {
            logConcern(response, 'moderate', 'About Me discovery');

            addBotMessage(
                `I understand. ${response} is a valid concern that many people share.\n\n` +
                `Given what we've discussed, how confident are you in addressing this concern?`
            );

            awaitingResponse = { type: 'about_me_confidence' };
            setAnswerOptions(['Very confident', 'Somewhat confident', 'Not very confident']);
        }

        function handleAboutMeConfidence(response) {
            userProfile.aboutMe.confidenceLevel = response;
            userProfile.aboutMe.confidenceTimestamp = new Date().toISOString();
            updateAboutMeCompleteness(userProfile);
            saveUserProfile(userProfile);

            let confidenceResponse = "";
            if (response === "Very confident") {
                confidenceResponse = "Your confidence is inspiring!";
            } else if (response === "Somewhat confident") {
                confidenceResponse = "That's a good starting point.";
            } else {
                confidenceResponse = "That's okay. We'll work together to build your confidence.";
            }

            addBotMessage(
                `${confidenceResponse} Now that I understand what matters to you, let's continue with the session content.`
            );

            setAnswerOptions(null);
            setTimeout(() => startSessionContent(), 1500);
        }

        function handleSegmentResponse(response) {
            const lowerResponse = response.toLowerCase();

            if (lowerResponse.includes('continue') || lowerResponse === 'yes' ||
                lowerResponse.includes('ready to learn') || lowerResponse.includes('excited') ||
                lowerResponse.includes('nervous')) {

                let acknowledgment = "";
                if (lowerResponse.includes('ready to learn') || lowerResponse.includes('ready')) {
                    acknowledgment = "Excellent! Your readiness to learn is exactly the right mindset for brain health training.";
                } else if (lowerResponse.includes('excited')) {
                    acknowledgment = "I love your enthusiasm! That positive energy will serve you well in this journey.";
                } else if (lowerResponse.includes('nervous')) {
                    acknowledgment = "It's completely normal to feel nervous. We'll take this step by step, and you're in control.";
                } else {
                    acknowledgment = "Great! Let's continue with your brain health training.";
                }

                addBotMessage(acknowledgment);

                setTimeout(() => {
                    setAnswerOptions(null);
                    currentSegment++;
                    const content = getPersonalizedContent(currentSession.id, userProfile) || sessionContent[currentSession.id];
                    const module = content.modules[currentModule];
                    showContentSegment(module);
                }, 1500);
            } else if (lowerResponse.includes('tell me more')) {
                setAnswerOptions(null);
                addBotMessage("Let me provide more detail on this topic...");
                setTimeout(() => {
                    addBotMessage("Would you like to continue to the next topic?");
                    awaitingResponse = { type: 'segment_discussion' };
                    setAnswerOptions(['Continue', 'I have another question']);
                }, 2000);
            } else if (lowerResponse.includes('question')) {
                setAnswerOptions(null);
                addBotMessage("Please go ahead and ask your question. I'm here to help!");
                awaitingResponse = { type: 'user_question' };
            } else {
                addBotMessage("I understand. Let's continue with the training content.");
                setTimeout(() => {
                    setAnswerOptions(null);
                    currentSegment++;
                    const content = getPersonalizedContent(currentSession.id, userProfile) || sessionContent[currentSession.id];
                    const module = content.modules[currentModule];
                    showContentSegment(module);
                }, 1000);
            }
        }

        function showSessionMenu() {
            addBotMessage(
                "Here are the available training sessions. Each takes about 10 minutes to complete. " +
                "Click on any session to begin:"
            );

            setTimeout(() => {
                addBotMessage("", 'session_menu');
                awaitingResponse = { type: 'session_select' };
                setAnswerOptions(null);
            }, 500);
        }

        // User management
        function createNewUser() {
            const existingUsers = loadAvailableUsers();
            const nextUserNumber = existingUsers.length + 1;
            const newUserId = `user${nextUserNumber}`;
            const newUserName = `User ${nextUserNumber}`;

            const newUserProfile = {
                ...createDefaultUserHistory(),
                userId: newUserId,
                name: newUserName
            };

            const updatedUsers = [...existingUsers, { id: newUserId, name: newUserName }];
            saveUserList(updatedUsers);
            availableUsers = updatedUsers;

            currentUser = newUserId;
            userProfile = newUserProfile;
            messages = [];
            currentSession = null;
            awaitingResponse = null;

            localStorage.setItem(`brainHealth_${newUserId}`, JSON.stringify(newUserProfile));
            document.getElementById('currentUserName').textContent = newUserName;

            updateUserDropdown();
            renderMessages();

            addBotMessage(
                `Welcome to your Brain Health Companion! I'm here to help you understand and optimize your brain health.\n\n` +
                `Would you like to start with a training session or tell me about yourself first?`
            );
            awaitingResponse = { type: 'welcome' };
            setAnswerOptions(['Start Training', 'Tell You About Myself']);
        }

        function switchToUser(userId) {
            const savedProfile = localStorage.getItem(`brainHealth_${userId}`);
            if (savedProfile) {
                currentUser = userId;
                userProfile = JSON.parse(savedProfile);
                messages = [];
                currentSession = null;
                awaitingResponse = null;

                document.getElementById('currentUserName').textContent = userProfile.name;
                renderMessages();

                addBotMessage(`Welcome back, ${userProfile.name}! How can I help you today?`);
                showSessionMenu();
            }

            setShowUserDropdown(false);
        }

        function loadAvailableUsers() {
            const userList = localStorage.getItem('brainHealth_userList');
            if (userList) {
                return JSON.parse(userList);
            }
            return [];
        }

        function saveUserList(users) {
            localStorage.setItem('brainHealth_userList', JSON.stringify(users));
        }

        function updateUserDropdown() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            availableUsers.forEach(user => {
                if (user.id !== currentUser) {
                    const button = document.createElement('button');
                    button.textContent = user.name;
                    button.onclick = () => switchToUser(user.id);
                    userList.appendChild(button);
                }
            });
        }

        // Export functions
        function exportProgress() {
            const progressData = {
                profile: userProfile,
                aboutMe: userProfile.aboutMe,
                sessions: sessions.map(s => ({
                    ...s,
                    completed: userProfile.completedSessions.includes(s.id),
                    score: userProfile.sessionScores[s.id],
                    baselineResponses: userProfile.sessionScores[s.id]?.baseline
                })),
                exercises: userProfile.exerciseResults,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(progressData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = `brain-health-progress-${userProfile.userId}-${new Date().toISOString().split('T')[0]}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            addBotMessage(`Your complete progress report has been downloaded, including your About Me profile and knowledge progression data!`);
        }

        function setCurrentSegment(index) {
            currentSegment = index;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load available users
            const users = loadAvailableUsers();
            availableUsers = users;

            if (users.length === 0) {
                const firstUser = { id: 'user1', name: 'User 1' };
                saveUserList([firstUser]);
                availableUsers = [firstUser];
            }

            updateUserDropdown();

            // Show welcome message
            const hasMCI = userProfile.diagnosis?.includes("Mild Cognitive Impairment");
            const doctor = userProfile.assessment_info?.clinicians?.[0]?.name || 'your doctor';

            let welcomeMessage = `Welcome to your Brain Health Companion. I'm here to help you understand and optimize your brain health through personalized education and support.\n\n`;

            if (hasMCI) {
                welcomeMessage += `I see from your assessment that you have Mild Cognitive Impairment with an excellent cognitive score of ${userProfile.assessment_results?.ACE_III?.total || '98/100'}. `;
                welcomeMessage += `Your ${userProfile.patient_background?.symptom_duration || 'long-term'} stability is very encouraging.\n\n`;
            }

            welcomeMessage += `As your Cognitive Care Companion, I am here to help you understand what is happening to your brain as you age and to be the Companion you need to define and achieve the brain health goals that matter most to you. Next, I'll describe what you can do next and then work with you to determine where you would like to begin.\n\nAre you ready to begin?`;

            addBotMessage(welcomeMessage);
            awaitingResponse = { type: 'welcome' };
            setAnswerOptions(['Yes, show me the sessions', 'Tell me more about the program']);
        });

        // Enter key handler
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Click outside handler for dropdown
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-dropdown-container')) {
                setShowUserDropdown(false);
            }
        });
    </script>
</body>
</html>