<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMT Margin Performance Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .upload-container h2 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .upload-container p {
            color: #718096;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.05);
        }

        .upload-area.dragover {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .upload-content p {
            margin-bottom: 10px;
            color: #2d3748;
        }

        .upload-link {
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #a0aec0 !important;
        }

        .sample-data-option {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .sample-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            transition: transform 0.2s ease;
        }

        .sample-btn:hover {
            transform: translateY(-2px);
        }

        .data-status {
            background: #f0fff4;
            border: 1px solid #68d391;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #2f855a;
        }

        .data-status.error {
            background: #fed7d7;
            border-color: #fc8181;
            color: #c53030;
        }

        .filters-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .filter-group {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .filter-group h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .multi-select {
            position: relative;
            min-height: 40px;
        }

        .multi-select-button {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .multi-select-button:hover {
            border-color: #667eea;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            z-index: 999999;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f7fafc;
        }

        .dropdown-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .selected-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .insights-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .insights-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .insight-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .export-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .export-btn.secondary {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .export-btn.secondary:hover {
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            position: sticky;
            top: 0;
        }

        .center-column {
            text-align: center !important;
        }

        .projection-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .projection-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .projection-header h2 {
            color: #2d3748;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .projection-header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .projection-input-section {
            display: flex;
            align-items: end;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            color: #2d3748;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .input-group input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            min-width: 200px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .filters-section {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .export-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 RMT Margin Performance Dashboard</h1>
            <p>Comprehensive margin insights to drive performance optimization and profitability management</p>
            <button onclick="window.dashboard.loadPreloadedData()" style="margin-top: 15px; padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: transform 0.2s ease;">
                🔄 Refresh Data
            </button>
        </div>

        <!-- Status Summary Section -->
        <div id="statusSummarySection" class="bg-white rounded-lg shadow-sm mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">🎯 Status Summary</h2>
            </div>
            <div class="p-6">
                <div style="display: flex; gap: 20px; align-items: flex-start;">
                    <canvas id="statusSummaryChart" width="650" height="520"></canvas>
                    <canvas id="marginSummaryChart" width="650" height="520"></canvas>
                </div>
            </div>
        </div>

        <!-- Financial Performance Overview Section -->
        <div id="financialPerformanceSection" class="bg-white rounded-lg shadow-sm mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">📊 Financial Performance Overview</h2>
                <p class="text-sm text-gray-600 mt-1">Performance analysis for Jan-July 2024 vs 2025</p>
            </div>
            
            <!-- Key Metrics Summary -->
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 rounded-lg p-6 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalRevenue">$933K</p>
                                <div class="mt-1 text-green-600 flex items-center">
                                    <span class="mr-1">↗</span>35.4%
                                </div>
                            </div>
                            <div class="text-blue-500 text-2xl">💰</div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-6 border-l-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Expenses</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalExpenses">$788K</p>
                                <div class="mt-1 text-red-600 flex items-center">
                                    <span class="mr-1">↘</span>12.1%
                                </div>
                            </div>
                            <div class="text-green-500 text-2xl">📊</div>
                        </div>
                    </div>

                    <div class="bg-purple-50 rounded-lg p-6 border-l-4 border-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Visit Count</p>
                                <p class="text-2xl font-bold text-gray-900" id="visitCount">8,156</p>
                                <div class="mt-1 text-green-600 flex items-center">
                                    <span class="mr-1">↗</span>25.7%
                                </div>
                            </div>
                            <div class="text-purple-500 text-2xl">👥</div>
                        </div>
                    </div>

                    <div class="bg-orange-50 rounded-lg p-6 border-l-4 border-orange-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Profit per Visit</p>
                                <p class="text-2xl font-bold text-gray-900" id="profitPerVisit">$18</p>
                                <div class="mt-1 text-red-600 flex items-center">
                                    <span class="mr-1">↘</span>155.6%
                                </div>
                            </div>
                            <div class="text-orange-500 text-2xl">💰</div>
                        </div>
                    </div>
                </div>

                <!-- YOY Expense & Profitability Analysis -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">YOY Expense & Profitability Analysis</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="expenseAnalysisTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responsibility</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">2024 Jan-July</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">2025 Jan-July</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Growth</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Remaining Year Cashflow Projections -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="mr-2">📅</span>
                        Remaining Year Cashflow Projections
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">5-month projection based on current trends</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="cashflowTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">2023/24 Visit Avg</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">2025 Visit Projection</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Expenses</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Revenue</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Profit</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cash Position</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Insights Section -->
        <div id="dashboardContent" class="hidden">
            <div class="filters-section">
                <div class="filter-group">
                    <h3>📂 Category Filter</h3>
                    <div class="multi-select" id="categoryMultiSelect">
                        <div class="multi-select-button" onclick="window.dashboard.toggleDropdown('categoryDropdown')">
                            <span id="categoryButtonText">All Categories Selected</span>
                            <span>▼</span>
                        </div>
                        <div class="multi-select-dropdown" id="categoryDropdown"></div>
                    </div>
                </div>
                <div class="filter-group">
                    <h3>📈 Risk Classification</h3>
                    <div class="multi-select" id="marginMultiSelect">
                        <div class="multi-select-button" onclick="window.dashboard.toggleDropdown('marginDropdown')">
                            <span id="marginButtonText">All Classifications Selected</span>
                            <span>▼</span>
                        </div>
                        <div class="multi-select-dropdown" id="marginDropdown"></div>
                    </div>
                </div>
            </div>

            <div class="insights-section" id="statusSummarySection">
                <h2>🎯 Status Summary</h2>
                <div style="display: flex; align-items: flex-start; gap: 32px;">
                    <div style="min-width: 650px; max-width: 800px; width: 100%;">
                        <canvas id="statusSummaryChart" width="650" height="520"></canvas>
                    </div>
                    <div style="min-width: 650px; max-width: 800px; width: 100%;">
                        <canvas id="marginSummaryChart" width="650" height="520"></canvas>
                    </div>
                </div>
            </div>

            <div class="insights-section">
                <h2>�� Key Insights</h2>
                <div class="insight-item" id="expenseOutpacedInsight">
                    <span style="font-size: 1.2rem;">⚠️ </span>
                    <strong>Expenses Grew Faster Than Profit:</strong> <span id="expenseOutpacedText">Loading...</span>
                </div>
                <div class="insight-item" id="expenseGrewDespiteDeclineInsight">
                    <span style="font-size: 1.2rem;">⚠️ </span>
                    <strong>Expenses Grew Even Though Profit Declined:</strong> <span id="expenseGrewDespiteDeclineText">Loading...</span>
                </div>
                <div class="insight-item" id="topVarianceInsight">
                    <span style="font-size: 1.2rem;">📈 </span>
                    <strong>Expense in Most Recent Month with Highest Variance:</strong> <span id="topVarianceText">Loading...</span>
                </div>
                <div class="insight-item" id="marginInsight">
                    <span style="font-size: 1.2rem;">🏆 </span>
                    <strong>Top Performing Expense Categories with Controlled Cost (relative to change in revenue):</strong> <span id="topMarginText">Loading...</span>
                </div>
                <div class="insight-item" id="marketingROIInsight">
                    <span style="font-size: 1.2rem;">💰 </span>
                    <strong>Marketing Spend Efficiency:</strong> <span id="marketingROIText">Loading...</span>
                </div>
                <div class="insight-item" id="outpacingProfitInsight">
                    <span style="font-size: 1.2rem;">🚀 </span>
                    <strong>Consistently Outpacing Profit Growth:</strong> <span id="outpacingProfitText">Loading...</span>
                </div>
                
                <div style="margin-top: 20px; font-size: 0.9rem; color: #718096;">
                    <h4 style="color: #2d3748; margin-bottom: 10px;"><strong>Marketing Spend Efficiency</strong></h4>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><strong>Unclassified:</strong> Average marketing spend below $500 or missing data—unable to assess efficiency.</li>
                        <li><strong>Under-Leveraged:</strong> Marketing spend grew less than 80% of profit growth—likely room to increase investment.</li>
                        <li><strong>Efficient:</strong> Marketing spend growth tracked profit growth within ±20% (80–120%)—good ROI.</li>
                        <li><strong>Inefficient:</strong> Marketing spend grew more than 120% of profit growth—spend outpacing returns, needs review.</li>
                    </ul>
                </div>
            </div>

            <div class="chart-container">
                <h2>📊 Margin Risk Assessment</h2>
                <canvas id="performanceChart" width="400" height="300"></canvas>
                <div style="margin-top: 20px; font-size: 0.9rem; color: #718096;">
                    <h4 style="color: #2d3748; margin-bottom: 10px;"><strong>Margin Risk Assessment Definitions</strong></h4>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><strong>Margin Improvement:</strong> Expense reductions or better expense control relative to profit—expenses are declining, or increasing more slowly than profit, driving improved margins.</li>
                        <li><strong>Margin Risk:</strong> Expenses are rising faster than profit, or are increasing while profit is flat or declining. This expense appears to be threat to margins that warrants immediate investigation and action.</li>
                        <li><strong>Below Threshold:</strong> An expense category will be assigned "Below Threshold" if its average monthly expense is below $500 or if it's a one-time expense.</li>
                        <li><strong>Neutral:</strong> Expenses and profit are changing at similar rates, or neither cost nor profit are moving in a way that indicates significant risk or improvement. No immediate concern - keep under review.</li>
                    </ul>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h2>📋 Most Recent Month Key Insights</h2>
                    <div class="export-buttons">
                        <button class="export-btn" onclick="window.dashboard.exportFilteredData()">📊 Export Filtered Data</button>
                        <button class="export-btn secondary" onclick="window.dashboard.exportAllData()">📈 Export All Data</button>
                    </div>
                </div>
                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 15px; font-style: italic;">
                    <strong>Table Organization:</strong> Categories are ranked by Performance Diagnostic priority - Cost Spike items first, then Margin Risk items, then Stable/Fixed items. Within each priority group, items are sorted by highest June variance. June Expenses data is sourced from Jun 2025 column of your Excel file.
                </p>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th style="width: 140px;">Category</th>
                            <th class="center-column" style="width: 140px;">Expenses for Most Recent Month</th>
                            <th class="center-column" style="width: 170px;">Most Recent Month vs. Avg. of Prior Months</th>
                            <th class="center-column">Margin Risk Assessment</th>
                            <th class="center-column">Expense Growth Alignment</th>
                            <th class="center-column">Suggested Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div style="margin-top: 20px; font-size: 0.9rem; color: #718096;">
                    <h4 style="color: #2d3748; margin-bottom: 10px;"><strong>Margin Risk Assessment Definitions</strong></h4>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><strong>Margin Improvement:</strong> Expense reductions or better expense control relative to profit—expenses are declining, or increasing more slowly than profit, driving improved margins.</li>
                        <li><strong>Margin Risk:</strong> Expenses are rising faster than profit, or are increasing while profit is flat or declining. This expense appears to be threat to margins that warrants immediate investigation and action.</li>
                        <li><strong>Below Threshold:</strong> An expense category will be assigned "Below Threshold" if its average monthly expense is below $500 or if it's a one-time expense.</li>
                        <li><strong>Neutral:</strong> Expenses and profit are changing at similar rates, or neither cost nor profit are moving in a way that indicates significant risk or improvement. No immediate concern - keep under review.</li>
                    </ul>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h2>📋 Expense Trends Over Entire Dataset</h2>
                </div>
                <table id="growthRiskTable">
                    <thead>
                        <tr>
                            <th style="width: 180px;">Category</th>
                            <th class="center-column" style="width: 180px;">% of Months Expenses Outpaced Profit Change</th>
                            <th class="center-column" style="width: 220px;">% of Months Expenses Did Not Decline with Profit Change</th>
                            <th class="center-column" style="width: 220px;">% of Months Expenses Trended Opposite of Profit Change</th>
                            <th class="center-column" style="width: 220px;">Potential $ Loss Due to Excess Spending</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div style="margin-top: 24px; font-size: 0.9rem; color: #718096;">
                    <span style="font-weight: bold; color: #2d3748; font-size: 0.95rem;">Potential $ Loss Due to Excess Spending:</span>
                    <span style="color: #718096; font-size: 0.9rem;"> Excess cost is the amount by which an expense category's growth exceeds the growth in gross profit by more than 5%. For example, if gross profit rises by 5%, any portion of expense growth above 10% (5% profit increase + 5% buffer) is flagged as excess cost. If gross profit declines, expenses are expected to decline at least as much (plus 5%); any shortfall is counted as excess.</span>
                </div>
            </div>

            <div class="projection-container">
                <div class="projection-header">
                    <h2> Expense Projection Based on Gross Profit Forecast</h2>
                    <p>Enter an estimated gross profit to see projected expenses for each category</p>
                    <p style="font-size: 0.9rem; color: #718096; margin-top: 10px;">
                        <strong>Formula:</strong> Projected Expense = Fixed Cost Estimate + (Marginal Cost per $1 GP × Estimated Gross Profit)
                    </p>
                </div>
                
                <div class="projection-input-section">
                    <div class="input-group">
                        <label for="estimatedGP">Estimated Gross Profit for the Month ($)</label>
                        <input type="number" id="estimatedGP" value="147081" min="0" step="1000">
                    </div>
                    <button class="sample-btn" onclick="window.dashboard.calculateProjections()">Calculate Projections</button>
                </div>

                <div class="projection-summary">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                            <h3 id="totalProjectedExpenses" style="color: #f56565; font-size: 2rem; font-weight: bold; margin-bottom: 5px;">$0</h3>
                            <p style="color: #718096; font-size: 0.9rem;">Total Projected Expenses</p>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                            <h3 id="projectedProfit" style="color: #48bb78; font-size: 2rem; font-weight: bold; margin-bottom: 5px;">$0</h3>
                            <p style="color: #718096; font-size: 0.9rem;">Projected Profit</p>
                        </div>
                    </div>
                </div>

                <div class="projection-results">
                    <div class="table-header">
                        <h3>📊 Projected Expenses by Category</h3>
                        <div class="export-buttons">
                            <button class="export-btn secondary" onclick="window.dashboard.exportProjections()">📈 Export Projections</button>
                        </div>
                    </div>
                    <table id="projectionTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Fixed Cost Estimate</th>
                                <th>Marginal Cost per $1 GP</th>
                                <th>Projected Expense</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="top-drivers">
                    <h3>🚀 Top Expense Categories Growing Fastest with Revenue</h3>
                    <table id="topDriversTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Marginal Cost per $1 GP</th>
                                <th>Projected Expense</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.dashboard = {
            originalData: [],
            filteredData: [],
            modelData: [],
            performanceChart: null,
            isInitialized: false,

            sampleData: [
                {
                    "Category": "Other",
                    "January": 1163.8,
                    "February": 0.0,
                    "March": 0.0,
                    "April": -1125.0,
                    "May": 3094.46,
                    "Nonzero Month Count": 3,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 626.652,
                    "R² Linear": 0.4481,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 1053.841854364529,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 626.652,
                    "Reconciled Anchor Month Expense": 379.5974184259961,
                    "Estimated Future Expense": 626.652,
                    "Mean Prior Months Expense": 9.699999999999989,
                    "Mean All Months Expense": 626.652,
                    "Anchor vs Prior Avg ($)": 3084.76,
                    "Ratio_Change_Anchor_vs_MeanPrior": 318.0164948453612,
                    "Expense vs Profit Growth Ratio": -125.7704011981041,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Margin Risk – Investigate",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 1
                },
                {
                    "Category": "Total Taxes",
                    "January": 1163.8,
                    "February": 0.0,
                    "March": 0.0,
                    "April": -1125.0,
                    "May": 3094.46,
                    "Nonzero Month Count": 3,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 626.652,
                    "R² Linear": 0.4481,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 1053.841854364529,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 626.652,
                    "Reconciled Anchor Month Expense": 379.5974184259961,
                    "Estimated Future Expense": 626.652,
                    "Mean Prior Months Expense": 9.699999999999989,
                    "Mean All Months Expense": 626.652,
                    "Anchor vs Prior Avg ($)": 3084.76,
                    "Ratio_Change_Anchor_vs_MeanPrior": 318.0164948453612,
                    "Expense vs Profit Growth Ratio": -125.7704011981041,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Margin Risk – Investigate",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 2
                },
                {
                    "Category": "Net Other Income/Expense",
                    "January": -3328.87,
                    "February": -4545.14,
                    "March": -3460.13,
                    "April": -10716.94,
                    "May": -4673.57,
                    "Nonzero Month Count": 5,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": -5344.93,
                    "R² Linear": 0.0181,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 1215.905209574297,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": -5344.93,
                    "Reconciled Anchor Month Expense": -3237.716674753547,
                    "Estimated Future Expense": -5344.93,
                    "Mean Prior Months Expense": -5512.77,
                    "Mean All Months Expense": -5344.93,
                    "Anchor vs Prior Avg ($)": 839.2000000000007,
                    "Ratio_Change_Anchor_vs_MeanPrior": -0.1522283715808932,
                    "Expense vs Profit Growth Ratio": 0.06020386891180868,
                    "Expense Growth Alignment": "Costs Grew Slower than Profit",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 3
                },
                {
                    "Category": "Supplies/Giveaways",
                    "January": 1606.2,
                    "February": 0.0,
                    "March": 0.0,
                    "April": 0.0,
                    "May": 862.56,
                    "Nonzero Month Count": 2,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 493.7520000000001,
                    "R² Linear": 0.0,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 0.0,
                    "Model Status": "Insufficient-data",
                    "Estimated Anchor Month Expense": 493.7520000000001,
                    "Reconciled Anchor Month Expense": 299.0926136718186,
                    "Estimated Future Expense": 493.7520000000001,
                    "Mean Prior Months Expense": 401.55,
                    "Mean All Months Expense": 493.7520000000001,
                    "Anchor vs Prior Avg ($)": 461.0099999999999,
                    "Ratio_Change_Anchor_vs_MeanPrior": 1.148076204706761,
                    "Expense vs Profit Growth Ratio": -0.4540456460982601,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 4
                },
                {
                    "Category": "Physicians",
                    "January": 481.86,
                    "February": 0.0,
                    "March": 196.4,
                    "April": 193.22,
                    "May": 538.44,
                    "Nonzero Month Count": 4,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 281.984,
                    "R² Linear": 0.8292,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": -12.74300624680268,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 281.984,
                    "Reconciled Anchor Month Expense": 170.8131441971559,
                    "Estimated Future Expense": 281.984,
                    "Mean Prior Months Expense": 217.87,
                    "Mean All Months Expense": 281.984,
                    "Anchor vs Prior Avg ($)": 320.5700000000001,
                    "Ratio_Change_Anchor_vs_MeanPrior": 1.471382016799009,
                    "Expense vs Profit Growth Ratio": -0.5819078870687899,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 5
                },
                {
                    "Category": "Medical Waste Removal",
                    "January": 0.0,
                    "February": 0.0,
                    "March": 130.02,
                    "April": 130.02,
                    "May": 263.94,
                    "Nonzero Month Count": 3,
                    "One Time Expense": false,
                    "Marginal Cost per $1 GP": 0.0,
                    "Fixed Cost Estimate": 104.796,
                    "R² Linear": 0.462,
                    "Elasticity (Log-Log)": 0,
                    "Anchor Month Deviates from Trend ($)": 60.2350312182221,
                    "Model Status": "Clamped",
                    "Estimated Anchor Month Expense": 104.796,
                    "Reconciled Anchor Month Expense": 63.48067358178174,
                    "Estimated Future Expense": 104.796,
                    "Mean Prior Months Expense": 65.01,
                    "Mean All Months Expense": 104.796,
                    "Anchor vs Prior Avg ($)": 198.93,
                    "Ratio_Change_Anchor_vs_MeanPrior": 3.059990770650669,
                    "Expense vs Profit Growth Ratio": -1.210177060389181,
                    "Expense Growth Alignment": "Costs Declined Despite Profit Growth",
                    "Best Performing (Cost Decline Rank)": "",
                    "Efficiency Alert": "Below Threshold",
                    "Elasticity Classification": "Below Threshold",
                    "Margin Risk Assessment": "Below Threshold",
                    "Performance Diagnostic Assignment": "Below Threshold",
                    "Marketing Spend Efficiency": "",
                    "Ranking Priority": 6
                }
            ],

            // Function to check if a category should be excluded from projections
            isExcludedFromProjections: function(categoryName) {
                const category = categoryName.toLowerCase().trim();
                
                // Exact exclusions
                const exactExclusions = [
                    'net operating income',
                    'total income',
                    'gross profit',
                    'net income',
                    'unapplied cash payment income',
                    'total expenses'
                ];
                
                // Pattern exclusions
                const patternExclusions = [
                    'total 6', // Catches "Total 600100 Payroll expenses", etc.
                    '400000 management fees',
                    '420000 services - doctors',
                    '430000 medical services (pc)'
                ];
                
                // New exclusion patterns for income, profit, fee, fees, services - doctors, and medical services
                const newExclusions = [
                    'income',
                    'profit',
                    'fee',
                    'fees',
                    'services - doctors',
                    'medical services (pc)'
                ];
                
                // Check exact matches
                if (exactExclusions.includes(category)) {
                    return true;
                }
                
                // Check pattern matches
                for (let pattern of patternExclusions) {
                    if (category.includes(pattern)) {
                        return true;
                    }
                }
                
                // Check new exclusion patterns
                for (let pattern of newExclusions) {
                    if (category.includes(pattern)) {
                        console.log(`Excluding category "${categoryName}" due to pattern "${pattern}"`);
                        return true;
                    }
                }
                
                // Check if starts with "total"
                if (category.startsWith('total ')) {
                    return true;
                }
                
                return false;
            },

            init: function() {
                this.setupFileUpload();
                this.setupEventListeners();
            },

            setupFileUpload: function() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const useSampleDataBtn = document.getElementById('useSampleData');

                if (uploadArea && fileInput) {
                    uploadArea.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            this.handleFileUpload(e.target.files[0]);
                        }
                    });

                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.classList.add('dragover');
                    });

                    uploadArea.addEventListener('dragleave', () => {
                        uploadArea.classList.remove('dragover');
                    });

                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove('dragover');
                        if (e.dataTransfer.files.length > 0) {
                            this.handleFileUpload(e.dataTransfer.files[0]);
                        }
                    });
                }

                if (useSampleDataBtn) {
                    useSampleDataBtn.addEventListener('click', () => {
                        this.loadSampleData();
                    });
                }
            },

            setupEventListeners: function() {
                const estimatedGPInput = document.getElementById('estimatedGP');
                if (estimatedGPInput) {
                    estimatedGPInput.addEventListener('change', () => {
                        this.calculateProjections();
                    });
                }

                document.addEventListener('click', (event) => {
                    if (!event.target.closest('.multi-select')) {
                        const dropdowns = document.querySelectorAll('.multi-select-dropdown');
                        dropdowns.forEach(dropdown => dropdown.classList.remove('show'));
                    }
                });
            },

            handleFileUpload: function(file) {
                const reader = new FileReader();
                const fileName = file.name.toLowerCase();

                reader.onload = (e) => {
                    try {
                        let data;
                        if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                            data = this.parseExcel(e.target.result);
                        } else {
                            throw new Error('Please upload an Excel file (.xlsx or .xls)');
                        }

                        if (data && data.length > 0) {
                            this.originalData = data;
                            this.filteredData = [...data];
                            
                            // Create model data by filtering out excluded categories
                            this.modelData = data.filter(item => {
                                const hasModelData = item["Fixed Cost Estimate"] !== 0 || item["Marginal Cost per $1 GP"] !== 0;
                                const isNotExcluded = !this.isExcludedFromProjections(item.Category);
                                return hasModelData && isNotExcluded;
                            }).map(item => ({
                                "Category": item.Category,
                                "Fixed Cost Estimate": item["Fixed Cost Estimate"],
                                "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"]
                            }));
                            
                            this.initializeDashboard();
                            this.showUploadSuccess(file.name, data.length);
                        } else {
                            throw new Error('No valid data found in the file.');
                        }
                    } catch (error) {
                        console.error('File upload error:', error);
                        this.showUploadError(error.message);
                    }
                };

                reader.onerror = () => {
                    this.showUploadError('Error reading file. Please try again.');
                };

                reader.readAsArrayBuffer(file);
            },

            parseExcel: function(arrayBuffer) {
                console.log('parseExcel called');
                console.log('ArrayBuffer size:', arrayBuffer.byteLength);
                try {
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    console.log('Workbook sheets:', workbook.SheetNames);
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    console.log('Worksheet range:', worksheet['!ref']);
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        defval: ''
                    });

                    console.log('Raw JSON data length:', jsonData.length);
                    console.log('First few rows of raw data:', jsonData.slice(0, 3));

                    if (jsonData.length < 2) {
                        throw new Error('Excel file must contain at least a header row and one data row.');
                    }

                    const headers = jsonData[0];
                    const dataRows = jsonData.slice(1);

                    // Normalize headers: trim, replace multiple spaces/dashes with a single space, and lowercase
                    const normalizedHeaders = headers.map(h => h ? h.toString().replace(/[\s\-]+/g, ' ').trim() : '');

                    const processedData = dataRows.filter(row => {
                        return row[0] && row[0].toString().trim() !== '';
                    }).map((row) => {
                        const obj = {};
                        normalizedHeaders.forEach((header, index) => {
                            obj[header] = row[index] || '';
                        });
                        if (row === dataRows[0]) {
                            console.log('First parsed object (normalized headers):', obj);
                            Object.entries(obj).forEach(([k, v]) => {
                                console.log(`Key: '${k}' | Value: '${v}' | Char codes:`, k.split('').map(c => c.charCodeAt(0)));
                            });
                        }
                        const expenseGrowthAlignment = String(
                            obj['Expense Growth Alignment'] ||
                            ''
                        ).trim();
                        // Debug for Render environment - check first few rows
                        if (row === dataRows[0] || row === dataRows[1] || row === dataRows[2]) {
                            console.log(`=== RENDER DEBUG ROW ${dataRows.indexOf(row)} ===`);
                            console.log('Category:', obj['Category']);
                            console.log('Raw Expense Growth Alignment value:', obj['Expense Growth Alignment']);
                            console.log('Processed value:', expenseGrowthAlignment);
                            console.log('All keys in this row:', Object.keys(obj));
                            console.log('=== END DEBUG ===');
                        }
                        console.log(`Processing ${obj['Category']}: Expense Growth Alignment = "${expenseGrowthAlignment}"`);
                        return {
                            "Category": String(obj['Category'] || '').trim(),
                            "May": parseFloat(obj['May']) || 0,
                            "Jun 2025": parseFloat(obj['Jun 2025']) || 0,
                            "Anchor vs Prior Avg ($)": parseFloat(obj['Anchor vs Prior Avg ($)']) || 0,
                            "Performance Diagnostic Summary": String(obj['Margin Risk Assessment'] || '').trim(),
                            "Margin Leverage Classification": obj['Margin Risk Assessment'] === true ? 'High Risk' : 'Normal Risk',
                            "Ratio_Change_Anchor_vs_MeanPrior": parseFloat(obj['Ratio_Change_Anchor_vs_MeanPrior']) || 0,
                            "Fixed Cost Estimate": parseFloat(obj['Fixed Cost Estimate']) || 0,
                            "Marginal Cost per $1 GP": parseFloat(obj['Marginal Cost per $1 GP']) || 0,
                            "ROI Efficiency": parseFloat(obj['ROI Efficiency']) || 0,
                            "Efficiency Alert": String(obj['Efficiency Alert'] || '').trim(),
                            "Best Performing (Cost Decline Rank)": obj['Best Performing (Cost Decline Rank)'] || "",
                            "Expense Growth Alignment": expenseGrowthAlignment,
                            "Marketing Spend Efficiency": String(obj['Marketing Spend Efficiency'] || '').trim(),
                            "Elasticity Classification": String(obj['Elasticity Classification'] || '').trim(),
                            // Growth & Risk Driver columns
                            "% of Months Outpaced Growth": parseFloat(obj['% of Months Outpaced Growth']) || 0,
                            "% of Months Did Not Decline with Profit": parseFloat(obj['% of Months Did Not Decline with Profit']) || 0,
                            "% of Months Opposite Direction than Profit": parseFloat(obj['% of Months Opposite Direction than Profit']) || 0,
                            "Total Excess Costs (5% Buffer)": parseFloat(obj['Total Excess Costs (5% Buffer)']) || 0
                        };
                    });

                    return processedData;
                } catch (error) {
                    console.error('Excel parsing error:', error);
                    throw new Error(`Excel parsing failed: ${error.message}`);
                }
            },

            loadSampleData: function() {
                this.originalData = [...this.sampleData];
                this.filteredData = [...this.sampleData];
                
                // Create model data by filtering out excluded categories
                this.modelData = this.originalData.filter(item => {
                    const hasModelData = item["Fixed Cost Estimate"] !== 0 || item["Marginal Cost per $1 GP"] !== 0;
                    const isNotExcluded = !this.isExcludedFromProjections(item.Category);
                    return hasModelData && isNotExcluded;
                }).map(item => ({
                    "Category": item.Category,
                    "Fixed Cost Estimate": item["Fixed Cost Estimate"],
                    "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"]
                }));
                
                this.initializeDashboard();
                this.showUploadSuccess('Sample Data', this.sampleData.length);
            },

            loadPreloadedData: function() {
                console.log('loadPreloadedData called');
                
                // Add cache-busting timestamp to prevent caching
                const timestamp = new Date().getTime();
                
                // Try multiple sources for the Excel file with cache-busting
                const sources = [
                    `/expense-analysis.xlsx?t=${timestamp}&v=${Date.now()}`,
                    `/public/expense-analysis.xlsx?t=${timestamp}&v=${Date.now()}`
                ];
                
                const tryFetch = async (url) => {
                    try {
                        console.log('Trying to fetch from:', url);
                        
                        // Add cache-busting headers to prevent any caching
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        
                        console.log('Response status:', response.status);
                        
                        if (response.ok) {
                            const arrayBuffer = await response.arrayBuffer();
                            console.log('Successfully fetched file, parsing...');
                            
                            const data = this.parseExcel(arrayBuffer);
                            if (data && data.length > 0) {
                                // Debug: Log the first item to see what columns are available
                                console.log('=== MAIN DATA DEBUG ===');
                                console.log('First item from main data:', data[0]);
                                console.log('Main data columns:', Object.keys(data[0]));
                                console.log('Growth & Risk columns in main data:');
                                console.log('- % of Months Outpaced Growth:', data[0]['% of Months Outpaced Growth']);
                                console.log('- % of Months Did Not Decline with Profit:', data[0]['% of Months Did Not Decline with Profit']);
                                console.log('- % of Months Opposite Direction than Profit:', data[0]['% of Months Opposite Direction than Profit']);
                                console.log('- Total Excess Costs (5% Buffer):', data[0]['Total Excess Costs (5% Buffer)']);
                                console.log('=== END MAIN DATA DEBUG ===');
                                
                                this.originalData = data;
                                this.filteredData = [...data];
                                
                                // Create model data by filtering out excluded categories
                                this.modelData = data.filter(item => {
                                    const hasModelData = item["Fixed Cost Estimate"] !== 0 || item["Marginal Cost per $1 GP"] !== 0;
                                    const isNotExcluded = !this.isExcludedFromProjections(item.Category);
                                    return hasModelData && isNotExcluded;
                                }).map(item => ({
                                    "Category": item.Category,
                                    "Fixed Cost Estimate": item["Fixed Cost Estimate"],
                                    "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"]
                                }));
                                
                                // Load chunk2 data for Growth & Risk Drivers section
                                this.loadChunk2Data();
                                
                                this.initializeDashboard();
                                this.showUploadSuccess('Pre-loaded Data (Fresh)', data.length);
                                return true;
                            }
                        }
                        return false;
                    } catch (error) {
                        console.error('Error fetching from', url, ':', error);
                        return false;
                    }
                };
                
                // Try each source until one works
                const attemptLoad = async () => {
                    for (const source of sources) {
                        const success = await tryFetch(source);
                        if (success) {
                            console.log('Successfully loaded fresh data from:', source);
                            return;
                        }
                    }
                    
                    // If all sources fail, show error
                    console.error('Failed to load data from all sources');
                    this.showUploadError('Failed to load pre-loaded data. Please check your connection and try again.');
                };
                
                attemptLoad();
            },

            loadChunk2Data: function() {
                console.log('=== LOADING CHUNK2 DATA ===');
                // Sources for the chunk2 file - same pattern as main file
                const timestamp = new Date().getTime();
                const chunk2Sources = [
                    `/RMT-expense-analysis-chunk2.xlsx?t=${timestamp}&v=${Date.now()}`,
                    `/public/RMT-expense-analysis-chunk2.xlsx?t=${timestamp}&v=${Date.now()}`,
                    `/api/chunk2?t=${timestamp}&v=${Date.now()}`
                ];
                
                console.log('Trying chunk2 sources:', chunk2Sources);
                
                // Try to load chunk2 data (optional - won't break if it fails)
                let chunk2Loaded = false;
                chunk2Sources.forEach(source => {
                    if (chunk2Loaded) return; // Stop if already loaded
                    console.log('Attempting to fetch from:', source);
                    fetch(source, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    })
                    .then(response => {
                        console.log('Response status for', source, ':', response.status);
                        if (response.ok) {
                            return response.arrayBuffer();
                        }
                        throw new Error(`Failed to fetch chunk2 from ${source} - Status: ${response.status}`);
                    })
                    .then(arrayBuffer => {
                        console.log('Successfully fetched chunk2 file, parsing...');
                        const chunk2Data = this.parseExcel(arrayBuffer);
                        console.log('Parsed chunk2 data:', chunk2Data);
                        
                        if (chunk2Data && chunk2Data.length > 0) {
                            console.log('Chunk2 data loaded for Growth & Risk Drivers section only');
                            console.log('Number of chunk2 records:', chunk2Data.length);
                            console.log('First chunk2 record:', chunk2Data[0]);
                            console.log('Chunk2 columns available:', Object.keys(chunk2Data[0]));
                            
                            // Store chunk2 data separately - don't merge with main data
                            this.chunk2Data = chunk2Data;
                            chunk2Loaded = true;
                            
                            // Update only the Growth & Risk Drivers table
                            this.updateGrowthRiskTable();
                        } else {
                            console.log('Chunk2 data is empty or null');
                        }
                    })
                    .catch(error => {
                        console.log('Error loading chunk2 data from', source, ':', error);
                    });
                });
            },

            initializeDashboard: function() {
                const dashboardContent = document.getElementById('dashboardContent');
                if (dashboardContent) {
                    dashboardContent.classList.remove('hidden');
                }
                
                setTimeout(() => {
                    this.setupFilters();
                    this.updateCharts();
                    this.updateTable();
                    this.updateGrowthRiskTable();
                    
                    setTimeout(() => {
                        this.updateInsights();
                        this.calculateProjections();
                        this.isInitialized = true;
                    }, 200);
                }, 100);
            },

            setupFilters: function() {
                // Filter out excluded categories from dropdown options
                const categories = [...new Set(this.originalData
                    .filter(item => !this.isExcludedFromProjections(item.Category))
                    .map(item => item.Category))].sort();
                const marginClassifications = [...new Set(this.originalData.map(item => item['Margin Leverage Classification']))].sort();

                const categoryContainer = document.getElementById('categoryDropdown');
                if (categoryContainer) {
                    let categoryHTML = '';
                    categories.forEach(cat => {
                        const safeId = cat.replace(/[^a-zA-Z0-9]/g, '_');
                        categoryHTML += `
                            <div class="dropdown-item">
                                <input type="checkbox" id="cat_${safeId}" value="${cat}" checked onchange="window.dashboard.applyFilters(); window.dashboard.updateDropdownText('categoryDropdown', 'categoryButtonText')">
                                <label for="cat_${safeId}">${cat}</label>
                            </div>
                        `;
                    });
                    categoryContainer.innerHTML = categoryHTML;
                }

                const marginContainer = document.getElementById('marginDropdown');
                if (marginContainer) {
                    let marginHTML = '';
                    marginClassifications.forEach(margin => {
                        const safeId = margin.replace(/[^a-zA-Z0-9]/g, '_');
                        marginHTML += `
                            <div class="dropdown-item">
                                <input type="checkbox" id="margin_${safeId}" value="${margin}" checked onchange="window.dashboard.applyFilters(); window.dashboard.updateDropdownText('marginDropdown', 'marginButtonText')">
                                <label for="margin_${safeId}">${margin}</label>
                            </div>
                        `;
                    });
                    marginContainer.innerHTML = marginHTML;
                }

                this.updateDropdownText('categoryDropdown', 'categoryButtonText');
                this.updateDropdownText('marginDropdown', 'marginButtonText');
            },

            toggleDropdown: function(dropdownId) {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    dropdown.classList.toggle('show');
                }
            },

            updateDropdownText: function(dropdownId, buttonTextId) {
                const checkboxes = document.querySelectorAll(`#${dropdownId} input[type="checkbox"]:checked`);
                const buttonText = document.getElementById(buttonTextId);
                
                if (buttonText) {
                    if (checkboxes.length === 0) {
                        buttonText.innerHTML = 'None selected';
                    } else if (checkboxes.length === 1) {
                        buttonText.innerHTML = checkboxes[0].nextElementSibling.textContent;
                    } else {
                        buttonText.innerHTML = `${checkboxes.length} selected <span class="selected-count">${checkboxes.length}</span>`;
                    }
                }
            },

            applyFilters: function() {
                const selectedCategories = Array.from(document.querySelectorAll('#categoryDropdown input:checked')).map(cb => cb.value);
                const selectedMarginClassifications = Array.from(document.querySelectorAll('#marginDropdown input:checked')).map(cb => cb.value);

                this.filteredData = this.originalData.filter(item => 
                    selectedCategories.includes(item.Category) && 
                    selectedMarginClassifications.includes(item['Margin Leverage Classification']) &&
                    !this.isExcludedFromProjections(item.Category)
                );

                this.updateCharts();
                this.updateTable();
                this.updateGrowthRiskTable();
                
                if (this.isInitialized) {
                    this.updateInsights();
                }
            },

            updateCharts: function() {
                if (this.filteredData.length === 0) return;
                this.updatePerformanceChart();
            },

            updatePerformanceChart: function() {
                // Filter out revenue/income categories from the performance chart
                const chartData = this.filteredData.filter(item => 
                    !this.isExcludedFromProjections(item.Category)
                );
                
                const performanceCounts = {};
                chartData.forEach(item => {
                    const perf = item['Performance Diagnostic Summary'] || 'Unknown';
                    performanceCounts[perf] = (performanceCounts[perf] || 0) + 1;
                });

                const ctx1 = document.getElementById('performanceChart');
                if (!ctx1) return;

                if (this.performanceChart) {
                    this.performanceChart.destroy();
                }

                this.performanceChart = new Chart(ctx1.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(performanceCounts),
                        datasets: [{
                            label: 'Count',
                            data: Object.values(performanceCounts),
                            backgroundColor: ['#e53e3e', '#fd7900', '#48bb78', '#4299e1'],
                            borderRadius: 8,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                ticks: { 
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Math.round(value);
                                    }
                                } 
                            },
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }
                        }
                    }
                });
            },

            updateTable: function() {
                const table = document.getElementById('dataTable');
                if (!table) return;

                const tbody = table.querySelector('tbody');
                if (!tbody) return;

                // Filter out excluded categories from the table display
                const tableData = this.filteredData.filter(item => {
                    const isExcluded = this.isExcludedFromProjections(item.Category);
                    if (isExcluded) {
                        console.log(`Excluding from table: "${item.Category}"`);
                    }
                    return !isExcluded &&
                        item.Category.toLowerCase().trim() !== 'net ordinary income' &&
                        item.Category.toLowerCase().trim() !== 'gross profit';
                });

                // Debug: print keys of first row
                if (tableData.length > 0) {
                    console.log('First row keys in filteredData:', Object.keys(tableData[0]));
                    console.log('First row in filteredData:', tableData[0]);
                }

                if (tableData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No data available</td></tr>';
                    return;
                }

                const suggestedActionPriority = {
                    'Investigate - Potential Risk': 1,
                    'Efficient Scaling': 2,
                    'Productivity Gain': 3,
                    'Strong Cost Control': 4,
                    'Review Volatility': 5,
                    'No Comparison': 6,
                    'Stable - No Action': 7,
                    'Below Threshold': 8
                };

                const sortedData = [...tableData].sort((a, b) => {
                    const aAction = a['Efficiency Alert'] || 'N/A';
                    const bAction = b['Efficiency Alert'] || 'N/A';
                    const aPriority = suggestedActionPriority[aAction] || 999;
                    const bPriority = suggestedActionPriority[bAction] || 999;
                    
                    if (aPriority !== bPriority) {
                        return aPriority - bPriority;
                    }
                    
                    // Within the same action group, sort by category name
                    return (a.Category || '').localeCompare(b.Category || '');
                });

                let tableHTML = '';
                sortedData.forEach(item => {
                    tableHTML += '<tr>';
                    
                    // Category
                    tableHTML += `<td>${item.Category || 'N/A'}</td>`;
                    
                    // Expenses for Most Recent Month (now from 'Jun 2025')
                    const junExpenses = item['Jun 2025'] || 0;
                    tableHTML += `<td class="center-column">${Math.round(junExpenses).toLocaleString()}</td>`;
                    
                    // Most Recent Month vs. Avg. of Prior Months
                    const anchorPriorValue = item['Anchor vs Prior Avg ($)'] || 0;
                    tableHTML += `<td class="center-column">${Math.round(anchorPriorValue).toLocaleString()}</td>`;
                    
                    // Performance Diagnostic
                    tableHTML += `<td class="center-column">${item['Performance Diagnostic Summary'] || 'N/A'}</td>`;
                    
                    // Expense Growth Alignment (as text)
                    const expenseGrowthAlignment = item['Expense Growth Alignment'] || '';
                    console.log(`Table row for ${item.Category}: Expense Growth Alignment = "${expenseGrowthAlignment}"`);
                    console.log(`Full item for ${item.Category}:`, item);
                    tableHTML += `<td class="center-column">${expenseGrowthAlignment}</td>`;

                    // Suggested Action (using Efficiency Alert)
                    const suggestedAction = item['Efficiency Alert'] || 'N/A';
                    tableHTML += `<td class="center-column">${suggestedAction}</td>`;

                    tableHTML += '</tr>';
                });

                tbody.innerHTML = tableHTML;
            },

            updateInsights: function() {
                // For most insights, filter out excluded categories
                const insightData = this.filteredData.filter(item => 
                    !this.isExcludedFromProjections(item.Category) &&
                    item.Category.toLowerCase().trim() !== 'net ordinary income' &&
                    item.Category.toLowerCase().trim() !== 'gross profit'
                );



                // Expenses Grew Faster Than Profit (using Expense Growth Alignment)
                const outpacedCategories = insightData.filter(item => {
                    const growthAlignment = String(item['Expense Growth Alignment'] || '').trim();
                    return growthAlignment === 'Expenses Grew Faster Than Profit';
                });
                
                const expenseOutpacedElement = document.getElementById('expenseOutpacedText');
                if (expenseOutpacedElement) {
                    if (outpacedCategories.length > 0) {
                        const categoryNames = outpacedCategories.map(item => item.Category);
                        expenseOutpacedElement.textContent = `(${outpacedCategories.length}) ${categoryNames.join(', ')}`;
                    } else {
                        expenseOutpacedElement.textContent = '(0) No expense category in the most recent month fits this metric.';
                    }
                }

                // Expenses Grew Even Though Profit Declined (using Expense Growth Alignment)
                const grewDespiteDeclineCategories = insightData.filter(item => {
                    const growthAlignment = String(item['Expense Growth Alignment'] || '').trim();
                    return growthAlignment === 'Expenses Grew Even Though Profit Declined';
                });
                
                const expenseGrewDespiteDeclineElement = document.getElementById('expenseGrewDespiteDeclineText');
                if (expenseGrewDespiteDeclineElement) {
                    if (grewDespiteDeclineCategories.length > 0) {
                        const categoryNames = grewDespiteDeclineCategories.map(item => item.Category);
                        expenseGrewDespiteDeclineElement.textContent = `(${grewDespiteDeclineCategories.length}) ${categoryNames.join(', ')}`;
                    } else {
                        expenseGrewDespiteDeclineElement.textContent = '(0) No expense category in the most recent month fits this metric.';
                    }
                }

                // Highest variance (exclude Net Ordinary Expense and Gross Profit)
                const topVariance = this.filteredData
                    .filter(item => {
                        const variance = item['Anchor vs Prior Avg ($)'];
                        const cat = (item.Category || '').toLowerCase().trim();
                        return variance !== undefined && variance !== null && variance !== 0 &&
                            cat !== 'net ordinary income' && cat !== 'gross profit' && cat !== 'net ordinary expense';
                    })
                    .sort((a, b) => Math.abs(b['Anchor vs Prior Avg ($)']) - Math.abs(a['Anchor vs Prior Avg ($)']))[0];
                
                const topVarianceElement = document.getElementById('topVarianceText');
                if (topVarianceElement) {
                    if (topVariance) {
                        const varianceAmount = Math.round(topVariance['Anchor vs Prior Avg ($)']);
                        const sign = varianceAmount >= 0 ? '+' : '-';
                        const formattedVariance = `(${sign}${Math.abs(varianceAmount).toLocaleString()})`;
                        topVarianceElement.textContent = `${topVariance.Category} ${formattedVariance}`;
                    } else {
                        topVarianceElement.textContent = 'No variance data available';
                    }
                }

                // Top 3 Performing Expense Categories - USE ORIGINAL DATA (include Total categories for performance ranking)
                const topPerformingCategories = this.filteredData
                    .filter(item => {
                        const rank = item['Best Performing (Cost Decline Rank)'];
                        return rank === 1 || rank === 2 || rank === 3 || rank === "1" || rank === "2" || rank === "3";
                    })
                    .sort((a, b) => {
                        const aRank = parseInt(a['Best Performing (Cost Decline Rank)']) || 999;
                        const bRank = parseInt(b['Best Performing (Cost Decline Rank)']) || 999;
                        return aRank - bRank;
                    });
                
                const topMarginElement = document.getElementById('topMarginText');
                if (topMarginElement) {
                    if (topPerformingCategories.length > 0) {
                        const formattedList = topPerformingCategories
                            .map((item) => `${parseInt(item['Best Performing (Cost Decline Rank)'])}. ${item.Category}`)
                            .join(', ');
                        topMarginElement.textContent = formattedList;
                    } else {
                        topMarginElement.textContent = '(0) No expense category in the most recent month fits this metric.';
                    }
                }

                // Marketing Spend Efficiency - include 614000 Marketing & Advertising, Total 614000 Marketing, Advertising, and 614200 Internet & Social media
                const marketingEfficiencyCategories = this.filteredData.filter(item => {
                    const efficiency = item['Marketing Spend Efficiency'];
                    const hasEfficiencyData = efficiency && efficiency.toString().trim() !== '';
                    const cat = (item.Category || '').toLowerCase().trim();
                    const isMarketingSpecial = cat === '614000 marketing & advertising' || 
                                             cat === 'total 614000 marketing' || 
                                             cat === 'advertising' || 
                                             cat === '614200 internet & social media';
                    // Include the specific marketing categories
                    return hasEfficiencyData && isMarketingSpecial;
                });
                const roiElement = document.getElementById('marketingROIText');
                if (roiElement) {
                    if (marketingEfficiencyCategories.length > 0) {
                        const formattedList = marketingEfficiencyCategories
                            .map(item => `${item.Category} (${item['Marketing Spend Efficiency']})`)
                            .join(', ');
                        roiElement.textContent = formattedList;
                    } else {
                        roiElement.textContent = 'No marketing efficiency data available';
                    }
                }

                // Consistently Outpacing Profit Growth (Elasticity Classification = 'Over-scaled')
                const outpacingProfitCategories = this.filteredData.filter(item => {
                    const isExcluded = this.isExcludedFromProjections(item.Category);
                    if (isExcluded) {
                        console.log(`Excluding from Consistently Outpacing Profit Growth: "${item.Category}"`);
                    }
                    return !isExcluded && String(item['Elasticity Classification'] || '').trim() === 'Over-scaled';
                });
                const outpacingProfitElement = document.getElementById('outpacingProfitText');
                if (outpacingProfitElement) {
                    if (outpacingProfitCategories.length > 0) {
                        const categoryNames = outpacingProfitCategories.map(item => item.Category);
                        outpacingProfitElement.textContent = `(${outpacingProfitCategories.length}) ${categoryNames.join(', ')}`;
                    } else {
                        outpacingProfitElement.textContent = '(0) No expense category in the most recent month fits this metric.';
                    }
                }
            },

            calculateProjections: function() {
                const estimatedGPInput = document.getElementById('estimatedGP');
                const estimatedGP = estimatedGPInput ? parseFloat(estimatedGPInput.value) || 0 : 147081;
                
                // Calculate projections for all model data, excluding Net Ordinary Income and Gross Profit
                const projections = this.modelData.filter(item =>
                    item.Category.toLowerCase().trim() !== 'net ordinary income' &&
                    item.Category.toLowerCase().trim() !== 'gross profit'
                ).map(item => {
                    const projectedExpense = item["Fixed Cost Estimate"] + (item["Marginal Cost per $1 GP"] * estimatedGP);
                    return {
                        ...item,
                        "Projected Expense": Math.round(Math.max(0, projectedExpense))
                    };
                });

                const totalProjectedExpenses = projections.reduce((sum, item) => sum + item["Projected Expense"], 0);
                const projectedProfit = estimatedGP - totalProjectedExpenses;

                const totalExpensesElement = document.getElementById('totalProjectedExpenses');
                const projectedProfitElement = document.getElementById('projectedProfit');
                
                if (totalExpensesElement) {
                    totalExpensesElement.textContent = `$${totalProjectedExpenses.toLocaleString()}`;
                }
                
                if (projectedProfitElement) {
                    projectedProfitElement.textContent = `$${projectedProfit.toLocaleString()}`;
                    projectedProfitElement.style.color = projectedProfit >= 0 ? '#48bb78' : '#f56565';
                }

                this.updateProjectionsTable(projections);
                this.updateTopDriversTable(projections);
            },

            updateProjectionsTable: function(projections) {
                const tbody = document.querySelector('#projectionTable tbody');
                if (!tbody) return;
                
                let tableHTML = '';
                projections.forEach(item => {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${item.Category}</td>`;
                    tableHTML += `<td>${Math.round(item["Fixed Cost Estimate"]).toLocaleString()}</td>`;
                    tableHTML += `<td>${(item["Marginal Cost per $1 GP"] * 100).toFixed(2)}¢</td>`;
                    tableHTML += `<td>${item["Projected Expense"].toLocaleString()}</td>`;
                    tableHTML += '</tr>';
                });

                tbody.innerHTML = tableHTML;
            },

            updateTopDriversTable: function(projections) {
                const tbody = document.querySelector('#topDriversTable tbody');
                if (!tbody) return;
                
                const topDrivers = projections
                    .filter(item => item["Marginal Cost per $1 GP"] > 0)
                    .sort((a, b) => b["Marginal Cost per $1 GP"] - a["Marginal Cost per $1 GP"])
                    .slice(0, 5);
                
                let tableHTML = '';
                topDrivers.forEach(item => {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${item.Category}</td>`;
                    tableHTML += `<td>${(item["Marginal Cost per $1 GP"] * 100).toFixed(2)}¢</td>`;
                    tableHTML += `<td>${item["Projected Expense"].toLocaleString()}</td>`;
                    tableHTML += '</tr>';
                });

                tbody.innerHTML = tableHTML;
            },

            updateGrowthRiskTable: function() {
                const table = document.getElementById('growthRiskTable');
                if (!table) return;
                const tbody = table.querySelector('tbody');
                if (!tbody) return;
                
                // Use chunk2 data if available, otherwise use main data with empty values
                const chunk2Data = this.chunk2Data || [];
                const mainData = this.filteredData.filter(item => {
                    const isExcluded = this.isExcludedFromProjections(item.Category);
                    if (isExcluded) {
                        console.log(`Excluding from Growth & Risk Drivers: "${item.Category}"`);
                    }
                    return !isExcluded;
                }) || [];
                
                // Debug logging
                console.log('=== GROWTH RISK DEBUG ===');
                console.log('Chunk2 data available:', chunk2Data.length > 0);
                console.log('Main data available:', mainData.length > 0);
                if (chunk2Data.length > 0) {
                    console.log('First chunk2 item:', chunk2Data[0]);
                    console.log('Chunk2 columns:', Object.keys(chunk2Data[0]));
                    
                    // Log all column names to help identify the correct ones
                    const allColumns = Object.keys(chunk2Data[0]);
                    console.log('All available columns in chunk2:', allColumns);
                    
                    // Look for columns that might contain the data we need
                    const excessCostColumns = allColumns.filter(col => 
                        col.toLowerCase().includes('excess') || 
                        col.toLowerCase().includes('cost') || 
                        col.toLowerCase().includes('loss') ||
                        col.toLowerCase().includes('buffer')
                    );
                    console.log('Potential excess cost columns:', excessCostColumns);
                }
                console.log('=== END GROWTH RISK DEBUG ===');
                
                let tableHTML = '';
                let hasData = false;
                
                mainData.forEach(item => {
                    // Find matching chunk2 data for this category
                    const chunk2Item = chunk2Data.find(chunk2 => chunk2.Category === item.Category);
                    
                    // Use chunk2 data if available, otherwise fall back to main data
                    const dataSource = chunk2Item || item;
                    
                    // Try to find the correct column names for excess costs
                    let excessCostValue = 0;
                    if (dataSource) {
                        // Try multiple possible column names for excess costs
                        const possibleExcessColumns = [
                            'Total Excess Costs (5% Buffer)',
                            'Excess Costs (5% Buffer)',
                            'Total Excess Costs',
                            'Excess Costs',
                            'Potential Loss',
                            'Excess Spending'
                        ];
                        
                        for (const colName of possibleExcessColumns) {
                            if (dataSource[colName] !== undefined && dataSource[colName] !== null && dataSource[colName] !== '') {
                                excessCostValue = Number(dataSource[colName]);
                                console.log(`Found excess cost value for ${item.Category} in column "${colName}":`, excessCostValue);
                                break;
                            }
                        }
                    }
                    
                    // Get percentage values, using chunk2 data if available, otherwise main data
                    const outpacedGrowth = dataSource['% of Months Outpaced Growth'];
                    const didNotDecline = dataSource['% of Months Did Not Decline with Profit'];
                    const oppositeDirection = dataSource['% of Months Opposite Direction than Profit'];
                    
                    // Check if we have any meaningful data
                    if (outpacedGrowth !== undefined && outpacedGrowth !== null && outpacedGrowth !== '' && outpacedGrowth > 0) {
                        hasData = true;
                    }
                    if (didNotDecline !== undefined && didNotDecline !== null && didNotDecline !== '' && didNotDecline > 0) {
                        hasData = true;
                    }
                    if (oppositeDirection !== undefined && oppositeDirection !== null && oppositeDirection !== '' && oppositeDirection > 0) {
                        hasData = true;
                    }
                    if (excessCostValue > 0) {
                        hasData = true;
                    }
                    
                    tableHTML += '<tr>';
                    tableHTML += `<td>${item['Category'] || 'N/A'}</td>`;
                    tableHTML += `<td class="center-column">${outpacedGrowth !== undefined && outpacedGrowth !== null && outpacedGrowth !== '' ? Number(outpacedGrowth).toFixed(0) + '%' : '0%'}</td>`;
                    tableHTML += `<td class="center-column">${didNotDecline !== undefined && didNotDecline !== null && didNotDecline !== '' ? Number(didNotDecline).toFixed(0) + '%' : '0%'}</td>`;
                    tableHTML += `<td class="center-column">${oppositeDirection !== undefined && oppositeDirection !== null && oppositeDirection !== '' ? Number(oppositeDirection).toFixed(0) + '%' : '0%'}</td>`;
                    tableHTML += `<td class="center-column">${excessCostValue > 0 ? '$' + Math.round(excessCostValue).toLocaleString() : '$0'}</td>`;
                    tableHTML += '</tr>';
                });
                
                // If no meaningful data found, show a message
                if (!hasData) {
                    tableHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #718096; font-style: italic;">Growth & Risk Drivers data not available. This section requires additional data that may not be present in the current file.</td></tr>';
                }
                
                tbody.innerHTML = tableHTML;
            },

            exportFilteredData: function() {
                const exportData = this.filteredData.filter(item => 
                    !this.isExcludedFromProjections(item.Category)
                );
                this.exportData(exportData, 'margin_diagnostic_data_filtered.csv');
            },

            exportAllData: function() {
                const exportData = this.originalData.filter(item => 
                    !this.isExcludedFromProjections(item.Category)
                );
                this.exportData(exportData, 'margin_diagnostic_data_complete.csv');
            },

            exportProjections: function() {
                const estimatedGPInput = document.getElementById('estimatedGP');
                const estimatedGP = estimatedGPInput ? parseFloat(estimatedGPInput.value) || 0 : 147081;
                
                const projections = this.modelData.map(item => ({
                    "Category": item.Category,
                    "Fixed Cost Estimate": Math.round(item["Fixed Cost Estimate"]),
                    "Marginal Cost per $1 GP": item["Marginal Cost per $1 GP"],
                    "Projected Expense": Math.round(item["Fixed Cost Estimate"] + (item["Marginal Cost per $1 GP"] * estimatedGP)),
                    "Estimated Gross Profit": estimatedGP
                }));

                this.exportData(projections, `expense_projections_${estimatedGP.toLocaleString()}_gp.csv`);
            },

            exportData: function(dataToExport, fileName) {
                if (dataToExport.length === 0) {
                    alert('No data available to export');
                    return;
                }

                const headers = Object.keys(dataToExport[0]);
                const csvContent = [
                    headers.join(','),
                    ...dataToExport.map(row => 
                        headers.map(header => {
                            let value = row[header];
                            if (typeof value === 'number') {
                                value = Math.round(value);
                            }
                            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                                value = `"${value.replace(/"/g, '""')}"`;
                            }
                            return value;
                        }).join(',')
                    )
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`Data exported successfully as ${fileName}`);
            },

            showUploadSuccess: function(fileName, recordCount) {
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div class="data-status">
                            <h3>✅ Data Loaded Successfully!</h3>
                            <p><strong>File:</strong> ${fileName}</p>
                            <p><strong>Records loaded:</strong> ${recordCount}</p>
                            <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #48bb78; color: white; border: none; border-radius: 5px; cursor: pointer;">Upload Different File</button>
                        </div>
                    `;
                }
            },

            showUploadError: function(errorMessage) {
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div class="data-status error">
                            <h3>❌ Upload Error</h3>
                            <p>${errorMessage}</p>
                            <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #e53e3e; color: white; border: none; border-radius: 5px; cursor: pointer;">Try Again</button>
                        </div>
                    `;
                }
            },

            loadStatusSummaryData: function() {
                const fileName = 'Summary RMT Rev & Expense Data for Dashboard.xlsx';
                const publicPath = `/public/${fileName}`;
                const rootPath = `/${fileName}`;
                const sources = [publicPath, rootPath];
                const statusSummaryDiv = document.getElementById('statusSummaryItems');
                if (statusSummaryDiv) statusSummaryDiv.innerHTML = '<span>Loading...</span>';

                const tryFetch = async (url) => {
                    try {
                        const response = await fetch(url);
                        if (!response.ok) return false;
                        const arrayBuffer = await response.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                        if (jsonData && jsonData.length > 0) {
                            this.statusSummaryData = jsonData;
                            this.renderStatusSummary();
                            this.renderStatusSummaryChart();
                            return true;
                        }
                    } catch (e) {
                        return false;
                    }
                    return false;
                };

                (async () => {
                    for (const src of sources) {
                        const ok = await tryFetch(src);
                        if (ok) return;
                    }
                    if (statusSummaryDiv) statusSummaryDiv.innerHTML = '<span style="color:#e53e3e">No summary data found.</span>';
                })();
            },

            renderStatusSummary: function() {
                const statusSummaryDiv = document.getElementById('statusSummaryItems');
                if (!statusSummaryDiv) return;
                const data = this.statusSummaryData || [];
                if (!data.length) {
                    statusSummaryDiv.innerHTML = '<span>No summary data available.</span>';
                    return;
                }
                let html = '<ul style="padding-left:20px;line-height:1.7;">';
                data.forEach(row => {
                    Object.entries(row).forEach(([k, v]) => {
                        html += `<li><strong>${k}:</strong> ${v}</li>`;
                    });
                });
                html += '</ul>';
                statusSummaryDiv.innerHTML = html;
            },

            renderStatusSummaryChart: function() {
                const data = this.statusSummaryData || [];
                if (!data.length) {
                    console.log('Status Summary: No data loaded.');
                    return;
                }
                // Normalize headers for robustness
                const normalize = s => (s || '').toString().replace(/\s+/g, ' ').trim().toLowerCase();
                // Find actual keys
                const firstRow = data[0] || {};
                const keys = Object.keys(firstRow).reduce((acc, k) => {
                    acc[normalize(k)] = k;
                    return acc;
                }, {});
                const monthKey = keys['month'];
                const revKey = keys['revenue 2025'];
                const expKey = keys['expenses 2025'];
                if (!monthKey || !revKey || !expKey) {
                    console.log('Status Summary: Required columns not found. Keys:', Object.keys(firstRow));
                    return;
                }
                const months = [], revenue = [], expenses = [];
                let validRows = 0;
                data.forEach((row, i) => {
                    const m = row[monthKey], r = row[revKey], e = row[expKey];
                    if (m && r !== undefined && e !== undefined && r !== '' && e !== '') {
                        months.push(m);
                        revenue.push(Number(r) || 0);
                        expenses.push(Number(e) || 0);
                        validRows++;
                    } else {
                        console.log(`Status Summary: Skipping row ${i+1} due to missing values.`, row);
                    }
                });
                if (!validRows) {
                    console.log('Status Summary: No valid rows found for chart.');
                    const ctx = document.getElementById('statusSummaryChart');
                    if (ctx) ctx.parentElement.innerHTML = '<div style="color:#e53e3e;padding:2em;">No valid summary chart data found.<br>Check column names and data in the summary Excel file.</div>';
                    return;
                }
                const ctx = document.getElementById('statusSummaryChart');
                if (!ctx) return;
                if (window.statusSummaryChartInstance) window.statusSummaryChartInstance.destroy();
                window.statusSummaryChartInstance = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                type: 'bar',
                                label: 'Revenue 2025',
                                data: revenue,
                                backgroundColor: '#667eea',
                                yAxisID: 'y'
                            },
                            {
                                type: 'bar',
                                label: 'Expenses 2025',
                                data: expenses,
                                backgroundColor: '#48bb78',
                                yAxisID: 'y'
                            }
                        ]
                    },
                    options: {
                        responsive: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                type: 'linear',
                                position: 'left',
                                title: { display: true, text: 'Revenue/Expenses 2025' },
                                beginAtZero: true,
                                ticks: { callback: v => '$' + v.toLocaleString() }
                            }
                        }
                    }
                });

                // Render margin chart
                this.renderMarginSummaryChart(data, months);
            },

            renderMarginSummaryChart: function(data, months) {
                // Normalize headers for robustness
                const normalize = s => (s || '').toString().replace(/\s+/g, ' ').trim().toLowerCase();
                const firstRow = data[0] || {};
                const keys = Object.keys(firstRow).reduce((acc, k) => {
                    acc[normalize(k)] = k;
                    return acc;
                }, {});
                const margin2024Key = keys['2024 margin'];
                const margin2025Key = keys['2025 margin'];
                const monthKey = keys['month'];
                if (!monthKey || !margin2024Key || !margin2025Key) {
                    console.log('Margin Summary: Required columns not found. Keys:', Object.keys(firstRow));
                    return;
                }
                const margin2024 = [], margin2025 = [], marginMonths = [];
                let validRows = 0;
                data.forEach((row, i) => {
                    const m = row[monthKey], m24 = row[margin2024Key], m25 = row[margin2025Key];
                    if (m && m24 !== undefined && m25 !== undefined && m24 !== '' && m25 !== '') {
                        marginMonths.push(m);
                        // Convert to whole percent, e.g., -0.597 -> -60
                        margin2024.push(Math.round(Number(m24) * 100));
                        margin2025.push(Math.round(Number(m25) * 100));
                        validRows++;
                    } else {
                        console.log(`Margin Summary: Skipping row ${i+1} due to missing values.`, row);
                    }
                });
                if (!validRows) {
                    console.log('Margin Summary: No valid rows found for chart.');
                    const ctx = document.getElementById('marginSummaryChart');
                    if (ctx) ctx.parentElement.innerHTML = '<div style="color:#e53e3e;padding:2em;">No valid margin chart data found.<br>Check column names and data in the summary Excel file.</div>';
                    return;
                }
                const ctx = document.getElementById('marginSummaryChart');
                if (!ctx) return;
                if (window.marginSummaryChartInstance) window.marginSummaryChartInstance.destroy();
                window.marginSummaryChartInstance = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: marginMonths,
                        datasets: [
                            {
                                type: 'bar',
                                label: '2024 Margin',
                                data: margin2024,
                                backgroundColor: '#fdc88e', // light orange
                                yAxisID: 'y'
                            },
                            {
                                type: 'bar',
                                label: '2025 Margin',
                                data: margin2025,
                                backgroundColor: '#8ec6fd', // light blue
                                yAxisID: 'y'
                            }
                        ]
                    },
                    options: {
                        responsive: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                type: 'linear',
                                position: 'left',
                                title: { display: true, text: 'Margin (%)' },
                                beginAtZero: true,
                                ticks: {
                                    callback: v => Math.round(v) + '%',
                                    stepSize: 10
                                }
                            }
                        }
                    }
                });
            },

            // Load financial performance data
            loadFinancialPerformanceData: async function() {
                try {
                    const response = await fetch('/Financial Performance Data.xlsx');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const arrayBuffer = await response.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    this.financialPerformanceData = XLSX.utils.sheet_to_json(worksheet);
                    console.log('Financial Performance Data loaded:', this.financialPerformanceData);
                    this.renderFinancialPerformanceSection();
                } catch (error) {
                    console.error('Error loading financial performance data:', error);
                    // Use fallback data if file not found
                    this.renderFinancialPerformanceSectionWithFallback();
                }
            },

            // Render financial performance section with fallback data
            renderFinancialPerformanceSectionWithFallback: function() {
                // Fallback expense analysis data
                const expenseAnalysisData = [
                    {
                        title: "Total Expenses",
                        responsibility: "Team",
                        val2024: 896645,
                        val2025: 788324,
                        growth: -0.121
                    },
                    {
                        title: "Total Revenue", 
                        responsibility: "Team",
                        val2024: 689105,
                        val2025: 933263,
                        growth: 0.354
                    },
                    {
                        title: "Visit Count",
                        responsibility: "RCM/Marketing", 
                        val2024: 6488,
                        val2025: 8156,
                        growth: 0.257
                    },
                    {
                        title: "Standard Commitments",
                        responsibility: "Owner Controlled",
                        val2024: 233683,
                        val2025: 172552,
                        growth: -0.262
                    },
                    {
                        title: "Variable Operational Costs",
                        responsibility: "Ops - Clinical Administrator Controlled",
                        val2024: 485095,
                        val2025: 411129,
                        growth: -0.152
                    },
                    {
                        title: "Marketing & Advertising",
                        responsibility: "Owner Controlled",
                        val2024: 67696,
                        val2025: 75774,
                        growth: 0.119
                    },
                    {
                        title: "Revenue Proportional",
                        responsibility: "% of visits/revenue",
                        val2024: 109089,
                        val2025: 133509,
                        growth: 0.224
                    },
                    {
                        title: "Supply $ per Visit",
                        responsibility: "Ops - Clinical Administrator Controlled",
                        val2024: 16,
                        val2025: 9,
                        growth: -0.468
                    },
                    {
                        title: "Total Expense per visit",
                        responsibility: "Ops - Clinical Administrator Controlled",
                        val2024: 138,
                        val2025: 97,
                        growth: -0.301
                    },
                    {
                        title: "Revenue per Visit",
                        responsibility: "RCM/Marketing",
                        val2024: 106,
                        val2025: 114,
                        growth: 0.077
                    },
                    {
                        title: "Profit per Visit",
                        responsibility: "Team",
                        val2024: -32,
                        val2025: 18,
                        growth: -1.556
                    }
                ];

                // Fallback cashflow data
                const cashflowData = [
                    { month: "August", visitAvg: 840, visitProj: 1056, expenses: 102064, revenue: 120829, profit: 18765, cashPosition: 293765 },
                    { month: "September", visitAvg: 865, visitProj: 1087, expenses: 105102, revenue: 124425, profit: 19324, cashPosition: 313089 },
                    { month: "October", visitAvg: 915, visitProj: 1150, expenses: 111177, revenue: 131618, profit: 20441, cashPosition: 333530 },
                    { month: "November", visitAvg: 950, visitProj: 1194, expenses: 115430, revenue: 136652, profit: 21223, cashPosition: 354752 },
                    { month: "December", visitAvg: 1175, visitProj: 1477, expenses: 142768, revenue: 169017, profit: 26249, cashPosition: 381001 }
                ];

                this.renderExpenseAnalysisTable(expenseAnalysisData);
                this.renderCashflowTable(cashflowData);
                this.updateKeyMetrics(expenseAnalysisData);
            },

            // Render financial performance section
            renderFinancialPerformanceSection: function() {
                if (!this.financialPerformanceData || this.financialPerformanceData.length === 0) {
                    this.renderFinancialPerformanceSectionWithFallback();
                    return;
                }

                // Process the data and render tables
                // This will depend on the structure of your Excel file
                console.log('Rendering financial performance section with loaded data');
            },

            // Format currency values
            formatCurrency: function(value) {
                if (Math.abs(value) >= 1000000) {
                    return `$${Math.round(value / 1000000)}M`;
                } else if (Math.abs(value) >= 1000) {
                    return `$${Math.round(value / 1000)}K`;
                } else {
                    return `$${Math.round(value)}`;
                }
            },

            // Format visit count values
            formatVisitCount: function(value) {
                return value.toString();
            },

            // Format growth percentage
            formatGrowth: function(growth) {
                const percentage = (growth * 100).toFixed(0);
                const isPositive = growth >= 0;
                const arrow = isPositive ? '↗' : '↘';
                const color = isPositive ? 'text-green-600' : 'text-red-600';
                return `<div class="${color} flex items-center"><span class="mr-1">${arrow}</span>${percentage}%</div>`;
            },

            // Get responsibility color class
            getResponsibilityColor: function(responsibility) {
                const colors = {
                    "Team": "bg-blue-100 text-blue-800",
                    "Owner Controlled": "bg-purple-100 text-purple-800", 
                    "RCM/Marketing": "bg-green-100 text-green-800",
                    "Ops - Clinical Administrator Controlled": "bg-orange-100 text-orange-800",
                    "% of visits/revenue": "bg-gray-100 text-gray-800"
                };
                return colors[responsibility] || "bg-gray-100 text-gray-800";
            },

            // Render expense analysis table
            renderExpenseAnalysisTable: function(data) {
                const tbody = document.querySelector('#expenseAnalysisTable tbody');
                tbody.innerHTML = '';

                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${item.title}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${this.getResponsibilityColor(item.responsibility)}">
                                ${item.responsibility}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                            ${item.title === 'Visit Count' ? 
                                this.formatVisitCount(item.val2024) : 
                                this.formatCurrency(item.val2024)
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                            ${item.title === 'Visit Count' ? 
                                this.formatVisitCount(item.val2025) : 
                                this.formatCurrency(item.val2025)
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            ${this.formatGrowth(item.growth)}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            // Render cashflow table
            renderCashflowTable: function(data) {
                const tbody = document.querySelector('#cashflowTable tbody');
                tbody.innerHTML = '';

                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${item.month}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-sm text-gray-900">
                            ${this.formatVisitCount(item.visitAvg)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-sm text-gray-900">
                            ${this.formatVisitCount(item.visitProj)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-sm text-gray-900">
                            ${this.formatCurrency(item.expenses)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-sm text-gray-900">
                            <span class="text-sm text-gray-900">${this.formatCurrency(item.revenue)}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-sm text-green-600 font-medium">
                            ${this.formatCurrency(item.profit)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-sm text-gray-900 font-semibold">
                            ${this.formatCurrency(item.cashPosition)}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },

            // Update key metrics display
            updateKeyMetrics: function(data) {
                const revenueItem = data.find(item => item.title === 'Total Revenue');
                const expensesItem = data.find(item => item.title === 'Total Expenses');
                const visitItem = data.find(item => item.title === 'Visit Count');
                const profitItem = data.find(item => item.title === 'Profit per Visit');

                if (revenueItem) {
                    document.getElementById('totalRevenue').textContent = this.formatCurrency(revenueItem.val2025);
                }
                if (expensesItem) {
                    document.getElementById('totalExpenses').textContent = this.formatCurrency(expensesItem.val2025);
                }
                if (visitItem) {
                    document.getElementById('visitCount').textContent = this.formatVisitCount(visitItem.val2025);
                }
                if (profitItem) {
                    document.getElementById('profitPerVisit').textContent = this.formatCurrency(profitItem.val2025);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded at:', new Date().toISOString());
            window.dashboard.init();
            // Automatically load pre-loaded data
            window.dashboard.loadPreloadedData();
            window.dashboard.loadStatusSummaryData();
            window.dashboard.loadFinancialPerformanceData();
        });
    </script>
</body>
</html>
